<!doctype html>
<html class="theme-next use-motion theme-next-mist">
<head>
  

<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />








  <link rel="stylesheet" type="text/css" href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5"/>




<link rel="stylesheet" type="text/css" href="/css/main.css?v=0.4.5.1"/>


    <meta name="description" content="人只有无限努力" />



  <meta name="keywords" content="express,node.js," />





  <link rel="shorticon icon" type="image/x-icon" href="/favicon.ico?v=0.4.5.1" />


<meta name="description" content="学习环境Node.js ： 0.10.32
Express ： 4.10.2
MongoDB ： 2.6.1
快速开始安装 Expressexpress 是 Node.js 上最流行的 Web 开发框架，正如他的名字一样，使用它我们可以快速的开发一个 Web 应用。我们用 express 来搭建我们的博客，打开命令行，输入：
$ npm install -g express-generator
安">
<meta property="og:type" content="article">
<meta property="og:title" content="(转)1.一个简单的博客">
<meta property="og:url" content="http://yoursite.com/2015/09/17/(转)1.一个简单的博客/index.html">
<meta property="og:site_name" content="Hang'blog">
<meta property="og:description" content="学习环境Node.js ： 0.10.32
Express ： 4.10.2
MongoDB ： 2.6.1
快速开始安装 Expressexpress 是 Node.js 上最流行的 Web 开发框架，正如他的名字一样，使用它我们可以快速的开发一个 Web 应用。我们用 express 来搭建我们的博客，打开命令行，输入：
$ npm install -g express-generator
安">
<meta property="og:image" content="https://github.com/nswbmw/N-blog/blob/master/public/images/1.1.jpg?raw=true">
<meta property="og:image" content="https://github.com/nswbmw/N-blog/blob/master/public/images/1.2.jpg?raw=true">
<meta property="og:image" content="https://github.com/nswbmw/N-blog/blob/master/public/images/1.3.jpg?raw=true">
<meta property="og:image" content="https://github.com/nswbmw/N-blog/blob/master/public/images/1.2.jpg?raw=true">
<meta property="og:image" content="https://github.com/nswbmw/N-blog/blob/master/public/images/1.4.jpg?raw=true">
<meta property="og:image" content="https://github.com/nswbmw/N-blog/blob/master/public/images/1.5.jpg?raw=true">
<meta property="og:image" content="https://github.com/nswbmw/N-blog/blob/master/public/images/1.6.jpg?raw=true">
<meta property="og:image" content="https://github.com/nswbmw/N-blog/blob/master/public/images/1.7.jpg?raw=true">
<meta property="og:image" content="https://github.com/nswbmw/N-blog/blob/master/public/images/1.8.jpg?raw=true">
<meta property="og:image" content="https://github.com/nswbmw/N-blog/blob/master/public/images/1.9.jpg?raw=true">
<meta property="og:image" content="https://github.com/nswbmw/N-blog/blob/master/public/images/1.10.jpg?raw=true">
<meta property="og:image" content="https://github.com/nswbmw/N-blog/blob/master/public/images/1.6.jpg?raw=true">
<meta property="og:image" content="https://github.com/nswbmw/N-blog/blob/master/public/images/1.7.jpg?raw=true">
<meta property="og:image" content="https://github.com/nswbmw/N-blog/blob/master/public/images/1.8.jpg?raw=true">
<meta property="og:image" content="https://github.com/nswbmw/N-blog/blob/master/public/images/1.11.jpg?raw=true">
<meta property="og:image" content="https://github.com/nswbmw/N-blog/blob/master/public/images/1.12.jpg?raw=true">
<meta property="og:image" content="https://github.com/nswbmw/N-blog/blob/master/public/images/1.13.jpg?raw=true">
<meta property="og:image" content="https://github.com/nswbmw/N-blog/blob/master/public/images/1.14.jpg?raw=true">
<meta property="og:image" content="https://github.com/nswbmw/N-blog/blob/master/public/images/1.15.jpg?raw=true">
<meta property="og:image" content="https://github.com/nswbmw/N-blog/blob/master/public/images/1.16.jpg?raw=true">
<meta property="og:image" content="https://github.com/nswbmw/N-blog/blob/master/public/images/1.17.jpg?raw=true">
<meta property="og:image" content="https://github.com/nswbmw/N-blog/blob/master/public/images/1.18.jpg?raw=true">
<meta property="og:updated_time" content="2015-12-13T09:56:43.691Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="(转)1.一个简单的博客">
<meta name="twitter:description" content="学习环境Node.js ： 0.10.32
Express ： 4.10.2
MongoDB ： 2.6.1
快速开始安装 Expressexpress 是 Node.js 上最流行的 Web 开发框架，正如他的名字一样，使用它我们可以快速的开发一个 Web 应用。我们用 express 来搭建我们的博客，打开命令行，输入：
$ npm install -g express-generator
安">


<script type="text/javascript" id="hexo.configuration">
  var CONFIG = {
    scheme: 'Mist',
    sidebar: 'post'
  };
</script>

  <title> (转)1.一个简单的博客 | Hang'blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  <!--[if lte IE 8]>
  <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'>
    <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode">
      <img src="http://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820"
           alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari."
           style='margin-left:auto;margin-right:auto;display: block;'/>
    </a>
  </div>
<![endif]-->
  



  <div class="container one-column page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><h1 class="site-meta">
  <span class="logo-line-before"><i></i></span>
  <a href="/" class="brand" rel="start">
      <span class="logo">
        <i class="icon-next-logo"></i>
      </span>
      <span class="site-title">Hang'blog</span>
  </a>
  <span class="logo-line-after"><i></i></span>
</h1>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu ">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            <i class="menu-item-icon icon-next-home"></i> <br />
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            <i class="menu-item-icon icon-next-archives"></i> <br />
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            <i class="menu-item-icon icon-next-tags"></i> <br />
            标签
          </a>
        </li>
      

      
      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content"> 

  <div id="posts" class="posts-expand">
    

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              (转)1.一个简单的博客
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于
          <time itemprop="dateCreated" datetime="2015-09-17T18:19:26+08:00" content="2015-09-17 18:19:26">
            2015-09-17 18:19:26
          </time>
        </span>

        

        
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        <span itemprop="articleBody"><h2 id="学习环境">学习环境</h2><p><strong>Node.js</strong> ： 0.10.32</p>
<p><strong>Express</strong> ： 4.10.2</p>
<p><strong>MongoDB</strong> ： 2.6.1</p>
<h2 id="快速开始">快速开始</h2><h3 id="安装_Express">安装 Express</h3><p>express 是 Node.js 上最流行的 Web 开发框架，正如他的名字一样，使用它我们可以快速的开发一个 Web 应用。我们用 express 来搭建我们的博客，打开命令行，输入：</p>
<pre><code>$ npm <span class="operator"><span class="keyword">install</span> -<span class="keyword">g</span> express-generator</span>
</code></pre><p>安装 express 命令行工具，使用它我们可以初始化一个 express 项目。<br><a id="more"></a></p>
<h3 id="新建一个工程">新建一个工程</h3><p>在命令行中输入：</p>
<pre><code>$ express -e <span class="keyword">blog
</span>$ cd <span class="keyword">blog </span>&amp;&amp; npm install
</code></pre><p>初始化一个 express 项目并安装所需模块，如下图所示：</p>
<p><img src="https://github.com/nswbmw/N-blog/blob/master/public/images/1.1.jpg?raw=true" alt=""></p>
<p>然后运行：</p>
<pre><code><span class="variable">$ </span><span class="constant">DEBUG</span>=blog node ./bin/www
</code></pre><p>（上面的代码报错的话，可以这样运行启动项目：npm start）<br>启动项目，此时命令行中会显示 <strong>blog Express server listening on port 3000 +0ms</strong>，在浏览器里访问 <code>localhost:3000</code>，如下图所示：</p>
<p><img src="https://github.com/nswbmw/N-blog/blob/master/public/images/1.2.jpg?raw=true" alt=""></p>
<p>至此，我们用 express 初始化了一个工程项目，并指定使用 ejs 模板引擎，下一节我们讲解工程的内部结构。</p>
<h3 id="工程结构">工程结构</h3><p>我们回头看看生成的工程目录里面都有什么，打开我们的 blog 文件夹，里面如图所示：</p>
<p><img src="https://github.com/nswbmw/N-blog/blob/master/public/images/1.3.jpg?raw=true" alt=""></p>
<p><strong>app.js</strong>：启动文件，或者说入口文件<br><strong>package.json</strong>：存储着工程的信息及模块依赖，当在 dependencies 中添加依赖的模块时，运行 <code>npm install</code>，npm 会检查当前目录下的 package.json，并自动安装所有指定的模块<br><strong>node_modules</strong>：存放 package.json 中安装的模块，当你在 package.json 添加依赖的模块并安装后，存放在这个文件夹下<br><strong>public</strong>：存放 image、css、js 等文件<br><strong>routes</strong>：存放路由文件<br><strong>views</strong>：存放视图文件或者说模版文件<br><strong>bin</strong>：存放可执行文件</p>
<p>打开app.js,让我们看看里面究竟有什么:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> express = <span class="keyword">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">var</span> path = <span class="keyword">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">var</span> favicon = <span class="keyword">require</span>(<span class="string">'serve-favicon'</span>);</span><br><span class="line"><span class="keyword">var</span> logger = <span class="keyword">require</span>(<span class="string">'morgan'</span>);</span><br><span class="line"><span class="keyword">var</span> cookieParser = <span class="keyword">require</span>(<span class="string">'cookie-parser'</span>);</span><br><span class="line"><span class="keyword">var</span> bodyParser = <span class="keyword">require</span>(<span class="string">'body-parser'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> routes = <span class="keyword">require</span>(<span class="string">'./routes/index'</span>);</span><br><span class="line"><span class="keyword">var</span> users = <span class="keyword">require</span>(<span class="string">'./routes/users'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> app = express();</span><br><span class="line"></span><br><span class="line"><span class="comment">// view engine setup</span></span><br><span class="line">app.set(<span class="string">'views'</span>, path.join(__dirname, <span class="string">'views'</span>));</span><br><span class="line">app.set(<span class="string">'view engine'</span>, <span class="string">'ejs'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// uncomment after placing your favicon in /public</span></span><br><span class="line"><span class="comment">//app.use(favicon(__dirname + '/public/favicon.ico'));</span></span><br><span class="line">app.<span class="keyword">use</span>(logger(<span class="string">'dev'</span>));</span><br><span class="line">app.<span class="keyword">use</span>(bodyParser.json());</span><br><span class="line">app.<span class="keyword">use</span>(bodyParser.urlencoded(&#123; extended: <span class="keyword">false</span> &#125;));</span><br><span class="line">app.<span class="keyword">use</span>(cookieParser());</span><br><span class="line">app.<span class="keyword">use</span>(express.<span class="keyword">static</span>(path.join(__dirname, <span class="string">'public'</span>)));</span><br><span class="line"></span><br><span class="line">app.<span class="keyword">use</span>(<span class="string">'/'</span>, routes);</span><br><span class="line">app.<span class="keyword">use</span>(<span class="string">'/users'</span>, users);</span><br><span class="line"></span><br><span class="line"><span class="comment">// catch 404 and forward to error handler</span></span><br><span class="line">app.<span class="keyword">use</span>(<span class="function"><span class="keyword">function</span><span class="params">(req, res, next)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> err = <span class="keyword">new</span> Error(<span class="string">'Not Found'</span>);</span><br><span class="line">    err.status = <span class="number">404</span>;</span><br><span class="line">    next(err);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// error handlers</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// development error handler</span></span><br><span class="line"><span class="comment">// will print stacktrace</span></span><br><span class="line"><span class="keyword">if</span> (app.get(<span class="string">'env'</span>) === <span class="string">'development'</span>) &#123;</span><br><span class="line">    app.<span class="keyword">use</span>(<span class="function"><span class="keyword">function</span><span class="params">(err, req, res, next)</span> </span>&#123;</span><br><span class="line">        res.status(err.status || <span class="number">500</span>);</span><br><span class="line">        res.render(<span class="string">'error'</span>, &#123;</span><br><span class="line">            message: err.message,</span><br><span class="line">            error: err</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// production error handler</span></span><br><span class="line"><span class="comment">// no stacktraces leaked to user</span></span><br><span class="line">app.<span class="keyword">use</span>(<span class="function"><span class="keyword">function</span><span class="params">(err, req, res, next)</span> </span>&#123;</span><br><span class="line">    res.status(err.status || <span class="number">500</span>);</span><br><span class="line">    res.render(<span class="string">'error'</span>, &#123;</span><br><span class="line">        message: err.message,</span><br><span class="line">        error: &#123;&#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">module.exports = app;</span><br></pre></td></tr></table></figure>
<p>这里我们通过require()加载了express、path 等模块,以及 routes 文件夹下的index. js和 users.js 路由文件。 下面来讲解每行代码的含义。</p>
<p>(1) var app = express()：生成一个express实例 app。<br>(2)app.set(‘views’, path.join(__dirname, ‘views’))：设置 views 文件夹为存放视图文件的目录, 即存放模板文件的地方,__dirname 为全局变量,存储当前正在执行的脚本所在的目录。<br>(3)app.set(‘view engine’, ‘ejs’)：设置视图模板引擎为 ejs。<br>(4)app.use(favicon(__dirname + ‘/public/favicon.ico’))：设置/public/favicon.ico为favicon图标。<br>(5)app.use(logger(‘dev’))：加载日志中间件。<br>(6)app.use(bodyParser.json())：加载解析json的中间件。<br>(7)app.use(bodyParser.urlencoded({ extended: false }))：加载解析urlencoded请求体的中间件。<br>(8)app.use(cookieParser())：加载解析cookie的中间件。<br>(9)app.use(express.static(path.join(__dirname, ‘public’)))：设置public文件夹为存放静态文件的目录。<br>(10)app.use(‘/‘, routes);和app.use(‘/users’, users)：路由控制器。<br>(11)</p>
<figure class="highlight vbscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">app.use(<span class="keyword">function</span>(req, res, <span class="keyword">next</span>) &#123;</span><br><span class="line">    var <span class="built_in">err</span> = <span class="keyword">new</span> <span class="keyword">Error</span>(<span class="comment">'Not Found');</span></span><br><span class="line">    <span class="built_in">err</span>.status = <span class="number">404</span>;</span><br><span class="line">    <span class="keyword">next</span>(<span class="built_in">err</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>捕获404错误，并转发到错误处理器。<br>(12)</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">app</span>.<span class="literal">get</span>('env') === 'development') &#123;</span><br><span class="line">    <span class="keyword">app</span>.<span class="keyword">use</span>(function(<span class="keyword">err</span>, req, res, next) &#123;</span><br><span class="line">        res.status(<span class="keyword">err</span>.status || 500);</span><br><span class="line">        res.render('<span class="keyword">error</span>', &#123;</span><br><span class="line">            message: <span class="keyword">err</span>.message,</span><br><span class="line">            <span class="keyword">error</span>: <span class="keyword">err</span></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>开发环境下的错误处理器，将错误信息渲染error模版并显示到浏览器中。<br>(13)</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">app</span>.<span class="keyword">use</span>(function(<span class="keyword">err</span>, req, res, next) &#123;</span><br><span class="line">    res.status(<span class="keyword">err</span>.status || 500);</span><br><span class="line">    res.render('<span class="keyword">error</span>', &#123;</span><br><span class="line">        message: <span class="keyword">err</span>.message,</span><br><span class="line">        <span class="keyword">error</span>: &#123;&#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>生产环境下的错误处理器，将错误信息渲染error模版并显示到浏览器中。<br>(14)module.exports = app ：导出app实例供其他模块调用。</p>
<p>我们再看 bin/www 文件：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env node</span></span><br><span class="line"><span class="keyword">var</span> debug = <span class="keyword">require</span>(<span class="string">'debug'</span>)(<span class="string">'blog'</span>);</span><br><span class="line"><span class="keyword">var</span> app = <span class="keyword">require</span>(<span class="string">'../app'</span>);</span><br><span class="line"></span><br><span class="line">app.set(<span class="string">'port'</span>, process.env.PORT || <span class="number">3000</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> server = app.listen(app.get(<span class="string">'port'</span>), <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  debug(<span class="string">'Express server listening on port '</span> + server.address().port);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>(1)#!/usr/bin/env node：表明是 node 可执行文件。<br>(2)var debug = require(‘debug’)(‘blog’)：引入debug模块，打印调试日志。<br>(3)var app = require(‘../app’)：引入我们上面导出的app实例。<br>(4)app.set(‘port’, process.env.PORT || 3000)：设置端口号。<br>(5)</p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> server = app.listen(app.<span class="keyword">get</span>(<span class="string">'port'</span>), <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  debug(<span class="string">'Express server listening on port '</span> + server.address().port);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>启动工程并监听3000端口，成功后打印 Express server listening on port 3000。</p>
<p>我们再看 routes/index.js 文件：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">var</span> router = express.Router();</span><br><span class="line"></span><br><span class="line"><span class="comment">/* GET home page. */</span></span><br><span class="line">router.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  res.render(<span class="string">'index'</span>, &#123; title: <span class="string">'Express'</span> &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = router;</span><br></pre></td></tr></table></figure>
<p>生成一个路由实例用来捕获访问主页的GET请求，导出这个路由并在app.js中通过app.use(‘/‘, routes); 加载。这样，当访问主页时，就会调用res.render(‘index’, { title: ‘Express’ });渲染views/index.ejs模版并显示到浏览器中。</p>
<p>我们再看看 views/index.ejs 文件：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="doctype">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">title</span>&gt;</span><span class="tag">&lt;<span class="title">%=</span> <span class="attribute">title</span> %&gt;</span><span class="tag">&lt;/<span class="title">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">link</span> <span class="attribute">rel</span>=<span class="value">'stylesheet'</span> <span class="attribute">href</span>=<span class="value">'/stylesheets/style.css'</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="title">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">h1</span>&gt;</span><span class="tag">&lt;<span class="title">%=</span> <span class="attribute">title</span> %&gt;</span><span class="tag">&lt;/<span class="title">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">p</span>&gt;</span>Welcome to <span class="tag">&lt;<span class="title">%=</span> <span class="attribute">title</span> %&gt;</span><span class="tag">&lt;/<span class="title">p</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="title">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>在渲染模板时我们传入了一个变量 title 值为 express  字符串，模板引擎会将所有 &lt;%= title %&gt; 替换为 express ，然后将渲染后生成的html显示到浏览器中，如上图所示。</p>
<p>在这一小节我们学习了如何创建一个工程并启动它，了解了工程的大体结构和运作流程，下一小节我们将学习 express 的基本使用及路由控制。</p>
<h2 id="路由控制">路由控制</h2><h3 id="工作原理">工作原理</h3><p>routes/index.js 中有以下代码：</p>
<pre><code><span class="tag">router</span><span class="class">.get</span>(<span class="string">'/'</span>, <span class="function">function</span>(req, res){
  <span class="tag">res</span><span class="class">.render</span>(<span class="string">'index'</span>, { <span class="attribute">title</span>: <span class="string">'Express'</span> });
});
</code></pre><p>这段代码的意思是当访问主页时，调用 ejs 模板引擎，来渲染 index.ejs 模版文件（即将 title 变量全部替换为字符串 Express），生成静态页面并显示在浏览器中。 </p>
<p>我们来作一些修改，以上代码实现了路由的功能，我们当然可以不要 routes/index.js 文件，把实现路由功能的代码都放在 app.js 里，但随着时间的推移 app.js 会变得臃肿难以维护，这也违背了代码模块化的思想，所以我们把实现路由功能的代码都放在 routes/index.js 里。官方给出的写法是在 app.js 中实现了简单的路由分配，然后再去 index.js 中找到对应的路由函数，最终实现路由功能。我们不妨把路由控制器和实现路由功能的函数都放到 index.js 里，app.js 中只有一个总的路由接口。</p>
<p>最终将 app.js 修改为：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> express = <span class="keyword">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">var</span> path = <span class="keyword">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">var</span> favicon = <span class="keyword">require</span>(<span class="string">'serve-favicon'</span>);</span><br><span class="line"><span class="keyword">var</span> logger = <span class="keyword">require</span>(<span class="string">'morgan'</span>);</span><br><span class="line"><span class="keyword">var</span> cookieParser = <span class="keyword">require</span>(<span class="string">'cookie-parser'</span>);</span><br><span class="line"><span class="keyword">var</span> bodyParser = <span class="keyword">require</span>(<span class="string">'body-parser'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> routes = <span class="keyword">require</span>(<span class="string">'./routes/index'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> app = express();</span><br><span class="line"></span><br><span class="line">app.set(<span class="string">'port'</span>, process.env.PORT || <span class="number">3000</span>);</span><br><span class="line">app.set(<span class="string">'views'</span>, path.join(__dirname, <span class="string">'views'</span>));</span><br><span class="line">app.set(<span class="string">'view engine'</span>, <span class="string">'ejs'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//app.use(favicon(__dirname + '/public/favicon.ico'));</span></span><br><span class="line">app.<span class="keyword">use</span>(logger(<span class="string">'dev'</span>));</span><br><span class="line">app.<span class="keyword">use</span>(bodyParser.json());</span><br><span class="line">app.<span class="keyword">use</span>(bodyParser.urlencoded(&#123; extended: <span class="keyword">true</span> &#125;));</span><br><span class="line">app.<span class="keyword">use</span>(cookieParser());</span><br><span class="line">app.<span class="keyword">use</span>(express.<span class="keyword">static</span>(path.join(__dirname, <span class="string">'public'</span>)));</span><br><span class="line"></span><br><span class="line">routes(app);</span><br><span class="line"></span><br><span class="line">app.listen(app.get(<span class="string">'port'</span>), <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  console.log(<span class="string">'Express server listening on port '</span> + app.get(<span class="string">'port'</span>));</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>修改 index.js 如下：</p>
<pre><code>module.exports = <span class="function"><span class="keyword">function</span><span class="params">(app)</span> </span>{
  app.<span class="keyword">get</span>(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(req, res)</span> </span>{
    res.render(<span class="string">'index'</span>, { title: <span class="string">'Express'</span> });
  });
};
</code></pre><p>现在，再运行你的 app，你会发现主页毫无二致。这里我们在 routes/index.js 中通过 <code>module.exports</code> 导出了一个函数接口，在 app.js 中通过 <code>require</code> 加载了 index.js 然后通过 <code>routes(app)</code> 调用了 index.js 导出的函数。</p>
<h3 id="路由规则">路由规则</h3><p>express 封装了多种 http 请求方式，我们主要只使用 <code>get</code> 和 <code>post</code> 两种，即 <code>app.get()</code> 和 <code>app.post()</code> 。</p>
<p><code>app.get()</code> 和 <code>app.post()</code> 的第一个参数都为请求的路径，第二个参数为处理请求的回调函数，回调函数有两个参数分别是 req 和 res，代表请求信息和响应信息 。路径请求及对应的获取路径有以下几种形式：  </p>
<p><strong>req.query</strong>  </p>
<pre><code><span class="comment">// GET /search?q=tobi+ferret  </span>
req<span class="class">.query</span><span class="class">.q</span>  
<span class="comment">// =&gt; "tobi ferret"  </span>

<span class="comment">// GET /shoes?order=desc&amp;shoe[color]=blue&amp;shoe[type]=converse  </span>
req<span class="class">.query</span><span class="class">.order</span>  
<span class="comment">// =&gt; "desc"  </span>

req<span class="class">.query</span><span class="class">.shoe</span><span class="class">.color</span>  
<span class="comment">// =&gt; "blue"  </span>

req<span class="class">.query</span><span class="class">.shoe</span><span class="class">.type</span>  
<span class="comment">// =&gt; "converse"  </span>
</code></pre><p><strong>req.body</strong>  </p>
<pre><code><span class="comment">// POST user[name]=tobi&amp;user[email]=tobi@learnboost.com  </span>
req<span class="class">.body</span><span class="class">.user</span><span class="class">.name</span>  
<span class="comment">// =&gt; "tobi"  </span>

req<span class="class">.body</span><span class="class">.user</span><span class="class">.email</span>  
<span class="comment">// =&gt; "tobi@learnboost.com"  </span>

<span class="comment">// POST { "name": "tobi" }  </span>
req<span class="class">.body</span><span class="class">.name</span>  
<span class="comment">// =&gt; "tobi"  </span>
</code></pre><p><strong>req.params</strong></p>
<pre><code><span class="comment">// GET /user/tj  </span>
req<span class="class">.params</span><span class="class">.name</span>  
<span class="comment">// =&gt; "tj"  </span>

<span class="comment">// GET /file/javascripts/jquery.js  </span>
req<span class="class">.params</span>[<span class="number">0</span>]  
<span class="comment">// =&gt; "javascripts/jquery.js"  </span>
</code></pre><p><strong>req.param(name)</strong></p>
<pre><code><span class="comment">// ?name=tobi  </span>
req.<span class="function"><span class="title">param</span><span class="params">(<span class="string">'name'</span>)</span></span>  
<span class="comment">// =&gt; "tobi"  </span>

<span class="comment">// POST name=tobi  </span>
req.<span class="function"><span class="title">param</span><span class="params">(<span class="string">'name'</span>)</span></span>  
<span class="comment">// =&gt; "tobi"  </span>

<span class="comment">// /user/tobi for /user/:name   </span>
req.<span class="function"><span class="title">param</span><span class="params">(<span class="string">'name'</span>)</span></span>  
<span class="comment">// =&gt; "tobi"  </span>
</code></pre><p>不难看出：</p>
<ul>
<li><code>req.query</code>： 处理 get 请求，获取 get 请求参数</li>
<li><code>req.params</code>： 处理 /:xxx 形式的 get 或 post 请求，获取请求参数</li>
<li><code>req.body</code>： 处理 post 请求，获取 post 请求体</li>
<li><code>req.param()</code>： 处理 get 和 post 请求，但查找优先级由高到低为 req.params→req.body→req.query  </li>
</ul>
<p>路径规则还支持正则表达式，更多请查阅 <a href="http://expressjs.com/api.html" target="_blank" rel="external">Express 官方文档</a> 。</p>
<h3 id="添加路由规则">添加路由规则</h3><p>当我们访问 localhost:3000 时，会显示： </p>
<p><img src="https://github.com/nswbmw/N-blog/blob/master/public/images/1.2.jpg?raw=true" alt=""></p>
<p>当我们访问 localhost:3000/nswbmw 这种不存在的页面时就会显示： </p>
<p><img src="https://github.com/nswbmw/N-blog/blob/master/public/images/1.4.jpg?raw=true" alt=""></p>
<p>这是因为不存在 <code>/nswbmw</code> 的路由规则，而且它也不是一个 public 目录下的文件，所以 express 返回了 404 Not Found 的错误。下面我们来添加这条路由规则，使得当访问 localhost:3000/nswbmw 时，页面显示 hello,world!  </p>
<p><strong>注意</strong>：以下修改仅用于测试，看到效果后再把代码还原回来。</p>
<p>修改 index.js，在 <code>app.get(&#39;/&#39;)</code> 函数后添加一条路由规则：  </p>
<pre><code>app.<span class="keyword">get</span>(<span class="string">'/nswbmw'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(req, res)</span> </span>{
  res.send(<span class="string">'hello,world!'</span>);
});
</code></pre><p>重启之后，访问 localhost:3000/nswbmw 页面显示如下：</p>
<p><img src="https://github.com/nswbmw/N-blog/blob/master/public/images/1.5.jpg?raw=true" alt=""></p>
<p>很简单吧？这一节我们学习了基本的路由规则及如何添加一条路由规则，下一节我们将学习模板引擎的知识。</p>
<h2 id="模版引擎">模版引擎</h2><h3 id="什么是模板引擎">什么是模板引擎</h3><p>模板引擎（Template Engine）是一个将页面模板和要显示的数据结合起来生成 HTML 页面的工具。<br>如果说上面讲到的 express 中的路由控制方法相当于 MVC 中的控制器的话，那模板引擎就相当于 MVC 中的视图。</p>
<blockquote>
<p>模板引擎的功能是将页面模板和要显示的数据结合起来生成 HTML 页面。它既可以运<br>行在服务器端又可以运行在客户端，大多数时候它都在服务器端直接被解析为 HTML，解析完成后再传输给客户端，因此客户端甚至无法判断页面是否是模板引擎生成的。有时候模板引擎也可以运行在客户端，即浏览器中，典型的代表就是 XSLT，它以 XML 为输入，在客户端生成 HTML 页面。但是由于浏览器兼容性问题，XSLT 并不是很流行。目前的主流还是由服务器运行模板引擎。</p>
<p>在 MVC 架构中，模板引擎包含在服务器端。控制器得到用户请求后，从模型获取数据，调用模板引擎。模板引擎以数据和页面模板为输入，生成 HTML 页面，然后返回给控制器，由控制器交回客户端。 </p>
<p align="right">——《Node.js开发指南》</p>

</blockquote>
<p><strong>什么是 ejs ?</strong></p>
<p>ejs 是模板引擎的一种，也是我们这个教程中使用的模板引擎，因为它使用起来十分简单，而且与 express 集成良好。</p>
<h3 id="使用模板引擎">使用模板引擎</h3><p>前面我们通过以下两行代码设置了模板文件的存储位置和使用的模板引擎：</p>
<pre><code>app.<span class="keyword">set</span>(<span class="string">'views'</span>, __dirname + <span class="string">'/views'</span>);
app.<span class="keyword">set</span>(<span class="string">'view engine'</span>, <span class="string">'ejs'</span>);
</code></pre><p><strong>注意</strong>：我们通过 <code>express -e blog</code> 只是初始化了一个使用 ejs 模板引擎的工程而已，比如 node_modules 下添加了 ejs 模块，views 文件夹下有 index.ejs 。并不是说强制该工程只能使用 ejs 不能使用其他的模板引擎比如 jade，真正指定使用哪个模板引擎的是 <code>app.set(&#39;view engine&#39;, &#39;ejs&#39;);</code> 。</p>
<p>在 routes/index.js 中通过调用 <code>res.render()</code> 渲染模版，并将其产生的页面直接返回给客户端。它接受两个参数，第一个是模板的名称，即 views 目录下的模板文件名，扩展名 .ejs 可选。第二个参数是传递给模板的数据对象，用于模板翻译。</p>
<p>打开 views/index.ejs ，内容如下：</p>
<p><strong>index.ejs</strong> </p>
<pre><code><span class="doctype">&lt;!DOCTYPE html&gt;</span>
<span class="tag">&lt;<span class="title">html</span>&gt;</span>
  <span class="tag">&lt;<span class="title">head</span>&gt;</span>
    <span class="tag">&lt;<span class="title">title</span>&gt;</span><span class="tag">&lt;<span class="title">%=</span> <span class="attribute">title</span> %&gt;</span><span class="tag">&lt;/<span class="title">title</span>&gt;</span>
    <span class="tag">&lt;<span class="title">link</span> <span class="attribute">rel</span>=<span class="value">'stylesheet'</span> <span class="attribute">href</span>=<span class="value">'/stylesheets/style.css'</span> /&gt;</span>
  <span class="tag">&lt;/<span class="title">head</span>&gt;</span>
  <span class="tag">&lt;<span class="title">body</span>&gt;</span>
    <span class="tag">&lt;<span class="title">h1</span>&gt;</span><span class="tag">&lt;<span class="title">%=</span> <span class="attribute">title</span> %&gt;</span><span class="tag">&lt;/<span class="title">h1</span>&gt;</span>
    <span class="tag">&lt;<span class="title">p</span>&gt;</span>Welcome to <span class="tag">&lt;<span class="title">%=</span> <span class="attribute">title</span> %&gt;</span><span class="tag">&lt;/<span class="title">p</span>&gt;</span>
  <span class="tag">&lt;/<span class="title">body</span>&gt;</span>
<span class="tag">&lt;/<span class="title">html</span>&gt;</span>
</code></pre><p>当我们 <code>res.render(&#39;index&#39;, { title: &#39;Express&#39; });</code> 时，模板引擎会把 &lt;%= title %&gt; 替换成 Express，然后把替换后的页面显示给用户。  </p>
<p>渲染后生成的页面代码为：</p>
<pre><code><span class="doctype">&lt;!DOCTYPE html&gt;</span>
<span class="tag">&lt;<span class="title">html</span>&gt;</span>
  <span class="tag">&lt;<span class="title">head</span>&gt;</span>
    <span class="tag">&lt;<span class="title">title</span>&gt;</span>Express<span class="tag">&lt;/<span class="title">title</span>&gt;</span>
    <span class="tag">&lt;<span class="title">link</span> <span class="attribute">rel</span>=<span class="value">'stylesheet'</span> <span class="attribute">href</span>=<span class="value">'/stylesheets/style.css'</span> /&gt;</span>
  <span class="tag">&lt;/<span class="title">head</span>&gt;</span>
  <span class="tag">&lt;<span class="title">body</span>&gt;</span>
    <span class="tag">&lt;<span class="title">h1</span>&gt;</span>Express<span class="tag">&lt;/<span class="title">h1</span>&gt;</span>
    <span class="tag">&lt;<span class="title">p</span>&gt;</span>Welcome to Express<span class="tag">&lt;/<span class="title">p</span>&gt;</span>
  <span class="tag">&lt;/<span class="title">body</span>&gt;</span>
<span class="tag">&lt;/<span class="title">html</span>&gt;</span>
</code></pre><p><strong>注意</strong>：我们通过 <code>app.use(express.static(path.join(__dirname, &#39;public&#39;)))</code> 设置了静态文件目录为 public 文件夹，所以上面代码中的 <code>href=&#39;/stylesheets/style.css&#39;</code> 就相当于 <code>href=&#39;public/stylesheets/style.css&#39;</code> 。 </p>
<p>ejs 的标签系统非常简单，它只有以下三种标签： </p>
<ul>
<li>&lt;% code %&gt;：JavaScript 代码。  </li>
<li>&lt;%= code %&gt;：显示替换过 HTML 特殊字符的内容。  </li>
<li>&lt;%- code %&gt;：显示原始 HTML 内容。  </li>
</ul>
<p><strong>注意</strong>： <code>&lt;%= code %&gt;</code> 和 <code>&lt;%- code %&gt;</code> 的区别，当变量 code 为普通字符串时，两者没有区别。当 code 比如为 <code>&lt;h1&gt;hello&lt;/h1&gt;</code> 这种字符串时，<code>&lt;%= code %&gt;</code> 会原样输出 <code>&lt;h1&gt;hello&lt;/h1&gt;</code>，而 <code>&lt;%- code %&gt;</code> 则会显示 H1 大的 hello 字符串。  </p>
<p>我们可以在 <code>&lt;%  %&gt;</code> 内使用 JavaScript 代码。下面是 ejs 的官方示例：  </p>
<p><strong>The Data</strong>  </p>
<pre><code><span class="rule"><span class="attribute">supplies</span>:<span class="value"> [<span class="string">'mop'</span>, <span class="string">'broom'</span>, <span class="string">'duster'</span>]</span></span>
</code></pre><p><strong>The Template</strong></p>
<pre><code>&lt;ul&gt;
&lt;<span class="preprocessor">%</span> for<span class="comment">(var i=0; i&lt;supplies.length; i++)</span> {<span class="preprocessor">%</span>&gt;
   &lt;li&gt;&lt;<span class="preprocessor">%</span>= supplies[i] <span class="preprocessor">%</span>&gt;&lt;/li&gt;
&lt;<span class="preprocessor">%</span> } <span class="preprocessor">%</span>&gt;
&lt;/ul&gt;
</code></pre><p><strong>The Result</strong></p>
<pre><code><span class="tag">&lt;<span class="title">ul</span>&gt;</span>
  <span class="tag">&lt;<span class="title">li</span>&gt;</span>mop<span class="tag">&lt;/<span class="title">li</span>&gt;</span>
  <span class="tag">&lt;<span class="title">li</span>&gt;</span>broom<span class="tag">&lt;/<span class="title">li</span>&gt;</span>
  <span class="tag">&lt;<span class="title">li</span>&gt;</span>duster<span class="tag">&lt;/<span class="title">li</span>&gt;</span>
<span class="tag">&lt;/<span class="title">ul</span>&gt;</span>
</code></pre><p>我们可以用上述三种标签实现页面模板系统能实现的任何内容。</p>
<h3 id="页面布局">页面布局</h3><p>这里我们不使用layout进行页面布局，而是使用更为简单灵活的include。include 的简单使用如下：  </p>
<p><strong>index.ejs</strong></p>
<pre><code><span class="xml"></span>&lt;%-<span class="ruby"> <span class="keyword">include</span> a </span>%&gt;<span class="xml">
hello,world!
</span>&lt;%-<span class="ruby"> <span class="keyword">include</span> b </span>%&gt;<span class="xml"></span>
</code></pre><p><strong>a.ejs</strong></p>
<pre><code><span class="keyword">this</span> <span class="keyword">is</span> a.ejs
</code></pre><p><strong>b.ejs</strong></p>
<pre><code><span class="keyword">this</span> <span class="keyword">is</span> b.ejs
</code></pre><p>最终 index.ejs 会显示：</p>
<pre><code>this is <span class="tag">a</span><span class="class">.ejs</span>
hello,world!
this is <span class="tag">b</span>.ejs
</code></pre><p>这一节我们学习了模版引擎的相关知识，下一节我们正式开始学习如何从头开始搭建一个多人博客。</p>
<h2 id="搭建多人博客">搭建多人博客</h2><h3 id="功能分析">功能分析</h3><p>搭建一个简单的具有多人注册、登录、发表文章、登出功能的博客。  </p>
<h3 id="设计目标">设计目标</h3><p>未登录：主页左侧导航显示 home、login、register，右侧显示已发表的文章、发表日期及作者。<br>登陆后：主页左侧导航显示 home、post、logout，右侧显示已发表的文章、发表日期及作者。<br>用户登录、注册、发表成功以及登出后都返回到主页。  </p>
<p><strong>未登录</strong>：</p>
<p>主页：  </p>
<p><img src="https://github.com/nswbmw/N-blog/blob/master/public/images/1.6.jpg?raw=true" alt=""></p>
<p>登录页：</p>
<p><img src="https://github.com/nswbmw/N-blog/blob/master/public/images/1.7.jpg?raw=true" alt=""></p>
<p>注册页：</p>
<p><img src="https://github.com/nswbmw/N-blog/blob/master/public/images/1.8.jpg?raw=true" alt=""></p>
<p><strong>登录后</strong>：</p>
<p>主页:</p>
<p><img src="https://github.com/nswbmw/N-blog/blob/master/public/images/1.9.jpg?raw=true" alt=""></p>
<p>发表页：</p>
<p><img src="https://github.com/nswbmw/N-blog/blob/master/public/images/1.10.jpg?raw=true" alt=""></p>
<p><strong>注意</strong>：没有登出页，当点击 LOGOUT 后，退出登陆并返回到主页。</p>
<h3 id="路由规划">路由规划</h3><p>我们已经把设计的构想图贴出来了，接下来的任务就是完成路由规划了。路由规划，或者说控制器规划是整个网站的骨架部分，因为它处于整个架构的枢纽位置，相当于各个接口之间的粘合剂，所以应该优先考虑。</p>
<p>根据构思的设计图，我们作以下路由规划：  </p>
<pre><code>/ ：首页
/login ：用户登录
/<span class="keyword">reg</span> ：用户注册
/<span class="keyword">post</span> ：发表文章
/logout ：登出
</code></pre><p>我们要求 <code>/login</code> 和 <code>/reg</code> 只能是未登录的用户访问，而 <code>/post</code> 和 <code>/logout</code> 只能是已登录的用户访问。左侧导航列表则针对已登录和未登录的用户显示不同的内容。 </p>
<p>修改 index.js 如下：  </p>
<pre><code>module.exports = <span class="function"><span class="keyword">function</span><span class="params">(app)</span> </span>{
  app.<span class="keyword">get</span>(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(req, res)</span> </span>{
    res.render(<span class="string">'index'</span>, { title: <span class="string">'主页'</span> });
  });
  app.<span class="keyword">get</span>(<span class="string">'/reg'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(req, res)</span> </span>{
    res.render(<span class="string">'reg'</span>, { title: <span class="string">'注册'</span> });
  });
  app.post(<span class="string">'/reg'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(req, res)</span> </span>{
  });
  app.<span class="keyword">get</span>(<span class="string">'/login'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(req, res)</span> </span>{
    res.render(<span class="string">'login'</span>, { title: <span class="string">'登录'</span> });
  });
  app.post(<span class="string">'/login'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(req, res)</span> </span>{
  });
  app.<span class="keyword">get</span>(<span class="string">'/post'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(req, res)</span> </span>{
    res.render(<span class="string">'post'</span>, { title: <span class="string">'发表'</span> });
  });
  app.post(<span class="string">'/post'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(req, res)</span> </span>{
  });
  app.<span class="keyword">get</span>(<span class="string">'/logout'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(req, res)</span> </span>{
  });
};
</code></pre><p>如何针对已登录和未登录的用户显示不同的内容呢？或者说如何判断用户是否已经登陆了呢？进一步说如何记住用户的登录状态呢？我们通过引入会话（session）机制记录用户登录状态，还要访问数据库来保存和读取用户信息。下一节我们将学习如何使用数据库。</p>
<h2 id="使用数据库">使用数据库</h2><h3 id="MongoDB简介">MongoDB简介</h3><p>MongoDB 是一个基于分布式文件存储的 NoSQL（非关系型数据库）的一种，由 C++ 语言编写，旨在为 WEB 应用提供可扩展的高性能数据存储解决方案。MongoDB 支持的数据结构非常松散，是类似 json 的 bjson 格式，因此可以存储比较复杂的数据类型。MongoDB 最大的特点是他支持的查询语言非常强大，其语法有点类似于面向对象的查询语言，几乎可以实现类似关系数据库单表查询的绝大部分功能，而且还支持对数据建立索引。</p>
<p>MongoDB 没有关系型数据库中行和表的概念，不过有类似的文档和集合的概念。文档是 MongoDB 最基本的单位，每个文档都会以唯一的 _id 标识，文档的属性为 key/value 的键值对形式，文档内可以嵌套另一个文档，因此可以存储比较复杂的数据类型。集合是许多文档的总和，一个数据库可以有多个集合，一个集合可以有多个文档。</p>
<p>下面是一个 MongoDB 文档的示例： </p>
<pre><code>{ 
  <span class="string">"_id"</span> : ObjectId( <span class="string">"4f7fe8432b4a1077a7c551e8"</span> ),
  <span class="string">"name"</span> : <span class="string">"nswbmw"</span>,
  <span class="string">"age"</span> : <span class="number">22</span>,
  <span class="string">"email"</span> : [ <span class="string">"xxx@126.com"</span>, <span class="string">"xxx@gmail.com"</span> ],
  <span class="string">"family"</span> : {
    <span class="string">"mother"</span> : { ... },
    <span class="string">"father"</span> : { ... },
    <span class="string">"sister : {
      "</span>name<span class="string">" : "</span>miaomiao<span class="string">",
      "</span>age<span class="string">" : 27,
      "</span>email<span class="string">" : "</span>xxx@<span class="number">163.</span>com<span class="string">",
      "</span>family<span class="string">" : {
        "</span>mothe<span class="string">r" : { ... },
        "</span>fathe<span class="string">r" : { ... },
        "</span>brother : { ... },
        <span class="string">"husband"</span> : { ... },
        <span class="string">"son"</span> : { ... }
      }
    }
  }
}
</code></pre><p>更多有关 MongoDB 的知识请参阅 《mongodb权威指南》或查阅：<a href="http://www.mongodb.org/" target="_blank" rel="external">http://www.mongodb.org/</a></p>
<h3 id="安装MongoDB">安装MongoDB</h3><p>安装 MongoDB 很简单,去<a href="http://www.mongodb.org/downloads" target="_blank" rel="external">官网</a>下载对应系统的 MongoDB 压缩包即可。解压后将文件夹重命名为 mongodb，并在 mongodb 文件夹里新建 blog 文件夹作为我们博客内容的存储目录。进入到 bin 目录下：运行：</p>
<pre><code>mongod <span class="comment">--dbpath ../blog/</span>
</code></pre><p>以上命令的意思是:设置 blog 文件夹作为我们工程的存储目录并启动数据库。</p>
<h3 id="连接MongoDB">连接MongoDB</h3><p>数据库虽然安装并启动成功了，但我们需要连接数据库后才能使用数据库。怎么才能在 Node.js 中使用 MongoDB 呢？我们使用官方提供的 node-mongodb-native 驱动模块，打开 package.json，在 dependencies 中添加一行： </p>
<pre><code><span class="string">"mongodb"</span>: <span class="string">"1.4.15"</span>
</code></pre><p>然后运行 <code>npm install</code> 更新依赖的模块，稍等片刻后 mongodb 模块就下载并安装完成了。  </p>
<p>接下来在工程的根目录中创建 settings.js 文件，用于保存该博客工程的配置信息，比如数据库的连接信息。我们将数据库命名为 blog，因为数据库服务器在本地，所以 settings.js 文件的内容如下：</p>
<pre><code><span class="module"><span class="keyword">module</span>.exports = </span>{ 
  cookieSecret: <span class="string">'myblog'</span>, 
  db: <span class="string">'blog'</span>, 
  host: <span class="string">'localhost'</span>,
  port: <span class="number">27017</span>
}; 
</code></pre><p>其中 db 是数据库的名称，host 是数据库的地址，port是数据库的端口号，cookieSecret 用于 Cookie 加密与数据库无关，我们留作后用。</p>
<p>接下来在根目录下新建 models 文件夹，并在 models 文件夹下新建 db.js ，添加如下代码：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">var</span> settings = <span class="built_in">require</span>(<span class="string">'../settings'</span>),</span><br><span class="line">       Db = <span class="built_in">require</span>(<span class="string">'mongodb'</span>).Db,</span><br><span class="line">       Connection = <span class="built_in">require</span>(<span class="string">'mongodb'</span>).Connection,</span><br><span class="line">       Server = <span class="built_in">require</span>(<span class="string">'mongodb'</span>).Server;</span><br><span class="line">   <span class="built_in">module</span>.exports = <span class="keyword">new</span> Db(settings.db, <span class="keyword">new</span> Server(settings.host, settings.port),</span><br><span class="line">&#123;safe: <span class="literal">true</span>&#125;);</span><br></pre></td></tr></table></figure></p>
<p>其中通过 <code>new Db(settings.db, new Server(settings.host, settings.port), {safe: true});</code> 设置数据库名、数据库地址和数据库端口创建了一个数据库连接实例，并通过 <code>module.exports</code> 导出该实例。这样，我们就可以通过 require 这个文件来对数据库进行读写了。</p>
<p>打开 app.js，在 <code>var routes = require(&#39;./routes/index&#39;);</code> 下添加：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> settings = <span class="built_in">require</span>(<span class="string">'./settings'</span>);</span><br></pre></td></tr></table></figure>
<h3 id="会话支持">会话支持</h3><blockquote>
<p>会话是一种持久的网络协议，用于完成服务器和客户端之间的一些交互行为。会话是一个比连接粒度更大的概念， 一次会话可能包含多次连接，每次连接都被认为是会话的一次操作。在网络应用开发中，有必要实现会话以帮助用户交互。例如网上购物的场景，用户浏览了多个页面，购买了一些物品，这些请求在多次连接中完成。许多应用层网络协议都是由会话支持的，如 FTP、Telnet 等，而 HTTP 协议是无状态的，本身不支持会话，因此在没有额外手段的帮助下，前面场景中服务器不知道用户购买了什么。 </p>
<p>为了在无状态的 HTTP 协议之上实现会话，Cookie 诞生了。Cookie 是一些存储在客户端的信息，每次连接的时候由浏览器向服务器递交，服务器也向浏览器发起存储 Cookie 的请求，依靠这样的手段服务器可以识别客户端。我们通常意义上的 HTTP 会话功能就是这样实现的。具体来说，浏览器首次向服务器发起请求时，服务器生成一个唯一标识符并发送给客户端浏览器，浏览器将这个唯一标识符存储在 Cookie 中，以后每次再发起请求，客户端浏览器都会向服务器传送这个唯一标识符，服务器通过这个唯一标识符来识别用户。 对于开发者来说，我们无须关心浏览器端的存储，需要关注的仅仅是如何通过这个唯一标识符来识别用户。很多服务端脚本语言都有会话功能，如 PHP，把每个唯一标识符存储到文件中。</p>
<p align="right">——《Node.js开发指南》</p> 

</blockquote>
<p>express 也提供了会话中间件，默认情况下是把用户信息存储在内存中，但我们既然已经有了 MongoDB，不妨把会话信息存储在数据库中，便于持久维护。为了使用这一功能，我们需要借助 express-session 和 connect-mongo 这两个第三方中间件，在 package.json 中添加： </p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"express-session"</span>: <span class="string">"1.9.1"</span>,</span><br><span class="line"><span class="string">"connect-mongo"</span>: <span class="string">"0.4.1"</span></span><br></pre></td></tr></table></figure>
<p>运行npm install安装模块,打开app.js，添加以下代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> session = <span class="keyword">require</span>(<span class="string">'express-session'</span>);</span><br><span class="line"><span class="keyword">var</span> MongoStore = <span class="keyword">require</span>(<span class="string">'connect-mongo'</span>)(session);</span><br><span class="line"></span><br><span class="line">app.<span class="keyword">use</span>(session(&#123;</span><br><span class="line">  secret: settings.cookieSecret,</span><br><span class="line">  key: settings.db,<span class="comment">//cookie name</span></span><br><span class="line">  cookie: &#123;maxAge: <span class="number">1000</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span> * <span class="number">30</span>&#125;,<span class="comment">//30 days</span></span><br><span class="line">  store: <span class="keyword">new</span> MongoStore(&#123;</span><br><span class="line">    db: settings.db,</span><br><span class="line">    host: settings.host,</span><br><span class="line">    port: settings.port</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;));</span><br></pre></td></tr></table></figure>
<p>使用 express-session 和 connect-mongo 模块实现了将会化信息存储到mongoldb中。secret 用来防止篡改 cookie，key 的值为 cookie 的名字，通过设置 cookie 的 maxAge 值设定 cookie 的生存期，这里我们设置 cookie 的生存期为 30 天，设置它的 store 参数为 MongoStore 实例，把会话信息存储到数据库中，以避免丢失。在后面的小节中，我们可以通过 req.session 获取当前用户的会话对象，获取用户的相关信息。</p>
<h2 id="注册和登陆">注册和登陆</h2><p>我们已经准备好了数据库访问和会话的相关信息，接下来我们完成用户注册和登录功能。</p>
<h3 id="页面设计">页面设计</h3><p>首先我们来完成主页、登录页和注册页的页面设计。</p>
<p>修改 views/index.ejs 如下：  </p>
<pre><code><span class="xml"></span>&lt;%-<span class="ruby"> <span class="keyword">include</span> header </span>%&gt;<span class="xml">
这是主页
</span>&lt;%-<span class="ruby"> <span class="keyword">include</span> footer </span>%&gt;<span class="xml"></span>
</code></pre><p>在 views 文件夹下新建 header.ejs，添加如下代码：</p>
<pre><code><span class="doctype">&lt;!DOCTYPE html&gt;</span>
<span class="tag">&lt;<span class="title">html</span>&gt;</span>
<span class="tag">&lt;<span class="title">head</span>&gt;</span>
<span class="tag">&lt;<span class="title">meta</span> <span class="attribute">charset</span>=<span class="value">"UTF-8"</span> /&gt;</span>
<span class="tag">&lt;<span class="title">title</span>&gt;</span>Blog<span class="tag">&lt;/<span class="title">title</span>&gt;</span>
<span class="tag">&lt;<span class="title">link</span> <span class="attribute">rel</span>=<span class="value">"stylesheet"</span> <span class="attribute">href</span>=<span class="value">"/stylesheets/style.css"</span>&gt;</span>
<span class="tag">&lt;/<span class="title">head</span>&gt;</span>
<span class="tag">&lt;<span class="title">body</span>&gt;</span>

<span class="tag">&lt;<span class="title">header</span>&gt;</span>
<span class="tag">&lt;<span class="title">h1</span>&gt;</span><span class="tag">&lt;<span class="title">%=</span> <span class="attribute">title</span> %&gt;</span><span class="tag">&lt;/<span class="title">h1</span>&gt;</span>
<span class="tag">&lt;/<span class="title">header</span>&gt;</span>

<span class="tag">&lt;<span class="title">nav</span>&gt;</span>
<span class="tag">&lt;<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">a</span> <span class="attribute">title</span>=<span class="value">"主页"</span> <span class="attribute">href</span>=<span class="value">"/"</span>&gt;</span>home<span class="tag">&lt;/<span class="title">a</span>&gt;</span><span class="tag">&lt;/<span class="title">span</span>&gt;</span>
<span class="tag">&lt;<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">a</span> <span class="attribute">title</span>=<span class="value">"登录"</span> <span class="attribute">href</span>=<span class="value">"/login"</span>&gt;</span>login<span class="tag">&lt;/<span class="title">a</span>&gt;</span><span class="tag">&lt;/<span class="title">span</span>&gt;</span>
<span class="tag">&lt;<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">a</span> <span class="attribute">title</span>=<span class="value">"注册"</span> <span class="attribute">href</span>=<span class="value">"/reg"</span>&gt;</span>register<span class="tag">&lt;/<span class="title">a</span>&gt;</span><span class="tag">&lt;/<span class="title">span</span>&gt;</span>
<span class="tag">&lt;/<span class="title">nav</span>&gt;</span>

<span class="tag">&lt;<span class="title">article</span>&gt;</span>
</code></pre><p>新建 footer.ejs，添加如下代码：</p>
<pre><code><span class="tag">&lt;/article&gt;</span>
<span class="tag">&lt;/body&gt;</span>
<span class="tag">&lt;/html&gt;</span>
</code></pre><p>修改 public/stylesheets/style.css 如下：</p>
<pre><code><span class="comment">/* inspired by http://yihui.name/cn/ */</span>
*<span class="rules">{<span class="rule"><span class="attribute">padding</span>:<span class="value"><span class="number">0</span></span></span>;<span class="rule"><span class="attribute">margin</span>:<span class="value"><span class="number">0</span></span></span>;}</span>
<span class="tag">body</span><span class="rules">{<span class="rule"><span class="attribute">width</span>:<span class="value"><span class="number">600px</span></span></span>;<span class="rule"><span class="attribute">margin</span>:<span class="value"><span class="number">2em</span> auto</span></span>;<span class="rule"><span class="attribute">padding</span>:<span class="value"><span class="number">0</span> <span class="number">2em</span></span></span>;<span class="rule"><span class="attribute">font-size</span>:<span class="value"><span class="number">14px</span></span></span>;<span class="rule"><span class="attribute">font-family</span>:<span class="value"><span class="string">"Microsoft YaHei"</span></span></span>;}</span>
<span class="tag">p</span><span class="rules">{<span class="rule"><span class="attribute">line-height</span>:<span class="value"><span class="number">24px</span></span></span>;<span class="rule"><span class="attribute">margin</span>:<span class="value"><span class="number">1em</span> <span class="number">0</span></span></span>;}</span>
<span class="tag">header</span><span class="rules">{<span class="rule"><span class="attribute">padding</span>:<span class="value">.<span class="number">5em</span> <span class="number">0</span></span></span>;<span class="rule"><span class="attribute">border-bottom</span>:<span class="value"><span class="number">1px</span> solid <span class="hexcolor">#cccccc</span></span></span>;}</span>
<span class="tag">nav</span><span class="rules">{<span class="rule"><span class="attribute">float</span>:<span class="value">left</span></span>;<span class="rule"><span class="attribute">font-family</span>:<span class="value"><span class="string">"Microsoft YaHei"</span></span></span>;<span class="rule"><span class="attribute">font-size</span>:<span class="value"><span class="number">1.1em</span></span></span>;<span class="rule"><span class="attribute">text-transform</span>:<span class="value">uppercase</span></span>;<span class="rule"><span class="attribute">margin-left</span>:<span class="value">-<span class="number">12em</span></span></span>;<span class="rule"><span class="attribute">width</span>:<span class="value"><span class="number">9em</span></span></span>;<span class="rule"><span class="attribute">text-align</span>:<span class="value">right</span></span>;}</span>
<span class="tag">nav</span> <span class="tag">a</span><span class="rules">{<span class="rule"><span class="attribute">display</span>:<span class="value">block</span></span>;<span class="rule"><span class="attribute">text-decoration</span>:<span class="value">none</span></span>;<span class="rule"><span class="attribute">padding</span>:<span class="value">.<span class="number">7em</span> <span class="number">1em</span></span></span>;<span class="rule"><span class="attribute">color</span>:<span class="value"><span class="hexcolor">#000000</span></span></span>;}</span>
<span class="tag">nav</span> <span class="rule"><span class="attribute">a</span>:<span class="value">hover{background-color:<span class="hexcolor">#ff0000</span></span></span>;<span class="rule"><span class="attribute">color</span>:<span class="value"><span class="hexcolor">#f9f9f9</span></span></span>;<span class="rule"><span class="attribute">-webkit-transition</span>:<span class="value">color .<span class="number">2s</span> linear</span></span>;}
<span class="tag">article</span><span class="rules">{<span class="rule"><span class="attribute">font-size</span>:<span class="value"><span class="number">16px</span></span></span>;<span class="rule"><span class="attribute">padding-top</span>:<span class="value">.<span class="number">5em</span></span></span>;}</span>
<span class="tag">article</span> <span class="tag">a</span><span class="rules">{<span class="rule"><span class="attribute">color</span>:<span class="value"><span class="hexcolor">#dd0000</span></span></span>;<span class="rule"><span class="attribute">text-decoration</span>:<span class="value">none</span></span>;}</span>
<span class="tag">article</span> <span class="rule"><span class="attribute">a</span>:<span class="value">hover{color:<span class="hexcolor">#333333</span></span></span>;<span class="rule"><span class="attribute">text-decoration</span>:<span class="value">underline</span></span>;}
<span class="class">.info</span><span class="rules">{<span class="rule"><span class="attribute">font-size</span>:<span class="value"><span class="number">14px</span></span></span>;}</span>
</code></pre><p>运行 app ，主页显示如下：</p>
<p><img src="https://github.com/nswbmw/N-blog/blob/master/public/images/1.6.jpg?raw=true" alt=""></p>
<p>接下来在 views 文件夹下新建 login.ejs，内容如下：</p>
<pre><code>&lt;%- <span class="keyword">include</span> header %&gt;
&lt;<span class="keyword">form</span> method=<span class="string">"post"</span>&gt;
  用户名：&lt;<span class="keyword">input</span> <span class="keyword">type</span>=<span class="string">"text"</span> name=<span class="string">"name"</span>/&gt;&lt;<span class="keyword">br</span> /&gt;
  密码：  &lt;<span class="keyword">input</span> <span class="keyword">type</span>=<span class="string">"password"</span> name=<span class="string">"password"</span>/&gt;&lt;<span class="keyword">br</span> /&gt;
         &lt;<span class="keyword">input</span> <span class="keyword">type</span>=<span class="string">"submit"</span> value=<span class="string">"登录"</span>/&gt;
&lt;/<span class="keyword">form</span>&gt;
&lt;%- <span class="keyword">include</span> footer %&gt;
</code></pre><p>登录页面显示如下：</p>
<p><img src="https://github.com/nswbmw/N-blog/blob/master/public/images/1.7.jpg?raw=true" alt=""></p>
<p>在 views 文件夹下新建 reg.ejs，内容如下：</p>
<pre><code>&lt;%- <span class="keyword">include</span> header %&gt;
&lt;<span class="keyword">form</span> method=<span class="string">"post"</span>&gt;
  用户名：  &lt;<span class="keyword">input</span> <span class="keyword">type</span>=<span class="string">"text"</span> name=<span class="string">"name"</span>/&gt;&lt;<span class="keyword">br</span> /&gt;
  密码：    &lt;<span class="keyword">input</span> <span class="keyword">type</span>=<span class="string">"password"</span> name=<span class="string">"password"</span>/&gt;&lt;<span class="keyword">br</span> /&gt;
  确认密码：&lt;<span class="keyword">input</span> <span class="keyword">type</span>=<span class="string">"password"</span> name=<span class="string">"password-repeat"</span>/&gt;&lt;<span class="keyword">br</span> /&gt;
  邮箱：    &lt;<span class="keyword">input</span> <span class="keyword">type</span>=<span class="string">"email"</span> name=<span class="string">"email"</span>/&gt;&lt;<span class="keyword">br</span> /&gt;
           &lt;<span class="keyword">input</span> <span class="keyword">type</span>=<span class="string">"submit"</span> value=<span class="string">"注册"</span>/&gt;
&lt;/<span class="keyword">form</span>&gt;
&lt;%- <span class="keyword">include</span> footer %&gt;
</code></pre><p>注册页面显示如下：</p>
<p><img src="https://github.com/nswbmw/N-blog/blob/master/public/images/1.8.jpg?raw=true" alt=""></p>
<p>至此，未登录时的主页、注册页、登录页都已经完成。</p>
<p>现在，启动我们的博客看看吧。</p>
<p><strong>注意</strong>：每次我们更新代码后，都需要手动停止并重启应用，使用 supervisor 模块可以解决这个问题，每当我们保存修改的文件时，supervisor 都会自动帮我们重启应用。通过：</p>
<pre><code>$ npm <span class="operator"><span class="keyword">install</span> -<span class="keyword">g</span> supervisor</span>
</code></pre><p>安装 supervisor 。使用 supervisor 命令启动 app.js：</p>
<pre><code><span class="variable">$ </span>supervisor app.js
</code></pre><h3 id="页面通知">页面通知</h3><p>接下来我们实现用户的注册和登陆，在这之前我们需要引入 flash 模块来实现页面通知（即成功与错误信息的显示）的功能。  </p>
<p><strong>什么是 flash?</strong></p>
<p>我们所说的 flash 即 connect-flash 模块（<a href="https://github.com/jaredhanson/connect-flash" target="_blank" rel="external">https://github.com/jaredhanson/connect-flash</a>），flash 是一个在 session 中用于存储信息的特定区域。信息写入 flash ，下一次显示完毕后即被清除。典型的应用是结合重定向的功能，确保信息是提供给下一个被渲染的页面。</p>
<p>在 package.json 添加一行代码：</p>
<pre><code><span class="string">"connect-flash"</span>: <span class="string">"0.1.1"</span>    
</code></pre><p>然后 <code>npm install</code> 安装 connect-flash 模块。修改 app.js ，在 <code>var settings = require(&#39;./settings&#39;);</code> 后添加：</p>
<pre><code><span class="keyword">var</span> flash = <span class="built_in">require</span>(<span class="string">'connect-flash'</span>);
</code></pre><p>在 <code>app.set(&#39;view engine&#39;, &#39;ejs&#39;);</code> 后添加：</p>
<pre><code><span class="keyword">app</span>.<span class="keyword">use</span>(flash());
</code></pre><p>现在我们就可以使用 flash 功能了。</p>
<h3 id="注册响应">注册响应</h3><p>前面我们已经完成了注册页，当然现在点击注册是没有效果的，因为我们还没有实现处理 POST 请求的功能，下面就来实现它。</p>
<p>在 models 文件夹下新建 user.js，添加如下代码：</p>
<pre><code><span class="keyword">var</span> mongodb = require(<span class="string">'./db'</span>);

<span class="function"><span class="keyword">function</span> <span class="title">User</span><span class="params">(user)</span> </span>{
  <span class="keyword">this</span>.name = user.name;
  <span class="keyword">this</span>.password = user.password;
  <span class="keyword">this</span>.email = user.email;
};

module.exports = User;

<span class="comment">//存储用户信息</span>
User.prototype.save = <span class="function"><span class="keyword">function</span><span class="params">(callback)</span> </span>{
  <span class="comment">//要存入数据库的用户文档</span>
  <span class="keyword">var</span> user = {
      name: <span class="keyword">this</span>.name,
      password: <span class="keyword">this</span>.password,
      email: <span class="keyword">this</span>.email
  };
  <span class="comment">//打开数据库</span>
  mongodb.open(<span class="function"><span class="keyword">function</span> <span class="params">(err, db)</span> </span>{
    <span class="keyword">if</span> (err) {
      <span class="keyword">return</span> <span class="keyword">callback</span>(err);<span class="comment">//错误，返回 err 信息</span>
    }
    <span class="comment">//读取 users 集合</span>
    db.collection(<span class="string">'users'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(err, collection)</span> </span>{
      <span class="keyword">if</span> (err) {
        mongodb.close();
        <span class="keyword">return</span> <span class="keyword">callback</span>(err);<span class="comment">//错误，返回 err 信息</span>
      }
      <span class="comment">//将用户数据插入 users 集合</span>
      collection.insert(user, {
        safe: <span class="literal">true</span>
      }, <span class="function"><span class="keyword">function</span> <span class="params">(err, user)</span> </span>{
        mongodb.close();
        <span class="keyword">if</span> (err) {
          <span class="keyword">return</span> <span class="keyword">callback</span>(err);<span class="comment">//错误，返回 err 信息</span>
        }
        <span class="keyword">callback</span>(<span class="literal">null</span>, user[<span class="number">0</span>]);<span class="comment">//成功！err 为 null，并返回存储后的用户文档</span>
      });
    });
  });
};

<span class="comment">//读取用户信息</span>
User.get = <span class="function"><span class="keyword">function</span><span class="params">(name, callback)</span> </span>{
  <span class="comment">//打开数据库</span>
  mongodb.open(<span class="function"><span class="keyword">function</span> <span class="params">(err, db)</span> </span>{
    <span class="keyword">if</span> (err) {
      <span class="keyword">return</span> <span class="keyword">callback</span>(err);<span class="comment">//错误，返回 err 信息</span>
    }
    <span class="comment">//读取 users 集合</span>
    db.collection(<span class="string">'users'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(err, collection)</span> </span>{
      <span class="keyword">if</span> (err) {
        mongodb.close();
        <span class="keyword">return</span> <span class="keyword">callback</span>(err);<span class="comment">//错误，返回 err 信息</span>
      }
      <span class="comment">//查找用户名（name键）值为 name 一个文档</span>
      collection.findOne({
        name: name
      }, <span class="function"><span class="keyword">function</span> <span class="params">(err, user)</span> </span>{
        mongodb.close();
        <span class="keyword">if</span> (err) {
          <span class="keyword">return</span> <span class="keyword">callback</span>(err);<span class="comment">//失败！返回 err 信息</span>
        }
        <span class="keyword">callback</span>(<span class="literal">null</span>, user);<span class="comment">//成功！返回查询的用户信息</span>
      });
    });
  });
};
</code></pre><p>我们通过 <code>User.prototype.save</code> 实现了用户信息的存储，通过 <code>User.get</code> 实现了用户信息的读取。</p>
<p>打开 index.js ，在最前面添加如下代码：  </p>
<pre><code><span class="keyword">var</span> crypto = <span class="built_in">require</span>(<span class="string">'crypto'</span>),
    User = <span class="built_in">require</span>(<span class="string">'../models/user.js'</span>);
</code></pre><p>通过 <code>require()</code> 引入 crypto 模块和 user.js 用户模型文件，crypto 是 Node.js 的一个核心模块，我们用它生成散列值来加密密码。  </p>
<p>修改 index.js 中 <code>app.post(&#39;/reg&#39;)</code> 如下：</p>
<pre><code>app.post(<span class="string">'/reg'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(req, res)</span> </span>{
  <span class="keyword">var</span> name = req.body.name,
      password = req.body.password,
      password_re = req.body[<span class="string">'password-repeat'</span>];
  <span class="comment">//检验用户两次输入的密码是否一致</span>
  <span class="keyword">if</span> (password_re != password) {
    req.flash(<span class="string">'error'</span>, <span class="string">'两次输入的密码不一致!'</span>); 
    <span class="keyword">return</span> res.redirect(<span class="string">'/reg'</span>);<span class="comment">//返回注册页</span>
  }
  <span class="comment">//生成密码的 md5 值</span>
  <span class="keyword">var</span> md5 = crypto.createHash(<span class="string">'md5'</span>),
      password = md5.update(req.body.password).digest(<span class="string">'hex'</span>);
  <span class="keyword">var</span> newUser = <span class="keyword">new</span> User({
      name: name,
      password: password,
      email: req.body.email
  });
  <span class="comment">//检查用户名是否已经存在 </span>
  User.<span class="keyword">get</span>(newUser.name, <span class="function"><span class="keyword">function</span> <span class="params">(err, user)</span> </span>{
    <span class="keyword">if</span> (err) {
      req.flash(<span class="string">'error'</span>, err);
      <span class="keyword">return</span> res.redirect(<span class="string">'/'</span>);
    }
    <span class="keyword">if</span> (user) {
      req.flash(<span class="string">'error'</span>, <span class="string">'用户已存在!'</span>);
      <span class="keyword">return</span> res.redirect(<span class="string">'/reg'</span>);<span class="comment">//返回注册页</span>
    }
    <span class="comment">//如果不存在则新增用户</span>
    newUser.save(<span class="function"><span class="keyword">function</span> <span class="params">(err, user)</span> </span>{
      <span class="keyword">if</span> (err) {
        req.flash(<span class="string">'error'</span>, err);
        <span class="keyword">return</span> res.redirect(<span class="string">'/reg'</span>);<span class="comment">//注册失败返回主册页</span>
      }
      req.session.user = user;<span class="comment">//用户信息存入 session</span>
      req.flash(<span class="string">'success'</span>, <span class="string">'注册成功!'</span>);
      res.redirect(<span class="string">'/'</span>);<span class="comment">//注册成功后返回主页</span>
    });
  });
});
</code></pre><p><strong>注意</strong>：我们把用户信息存储在了 session 里，以后就可以通过 req.session.user 读取用户信息。</p>
<ul>
<li><strong>req.body</strong>： 就是 POST 请求信息解析过后的对象，例如我们要访问 POST 来的表单内的 name=”password” 域的值，只需访问 req.body[‘password’] 或 req.body.password 即可。</li>
<li><strong>res.redirect</strong>： 重定向功能，实现了页面的跳转，更多关于 res.redirect 的信息请查阅：<a href="http://expressjs.com/api.html#res.redirect" target="_blank" rel="external">http://expressjs.com/api.html#res.redirect</a> 。</li>
<li><strong>User</strong>：在前面的代码中，我们直接使用了 User 对象。User 是一个描述数据的对象，即 MVC<br>架构中的模型。前面我们使用了许多视图和控制器，这是第一次接触到模型。与视图和控制器不同，模型是真正与数据打交道的工具，没有模型，网站就只是一个外壳，不能发挥真实的作用，因此它是框架中最根本的部分。</li>
</ul>
<p>现在，启动应用，在浏览器输入 localhost:3000 注册试试吧！注册成功后显示如下：</p>
<p><img src="https://github.com/nswbmw/N-blog/blob/master/public/images/1.11.jpg?raw=true" alt=""></p>
<p>这样我们并不知道是否注册成功，我们查看数据库中是否存入了用户的信息，打开一个命令行切换到 mongodb/bin/ （保证数据库已打开的前提下），输入：</p>
<p><img src="https://github.com/nswbmw/N-blog/blob/master/public/images/1.12.jpg?raw=true" alt=""></p>
<p>可以看到，用户信息已经成功存入数据库。</p>
<p>接下来我们实现当注册成功返回主页时，左侧导航显示 HOME 、POST 、LOGOUT ，右侧显示 <strong>注册成功！</strong> 字样，即添加 flash 的页面通知功能。</p>
<p>修改 header.ejs，将 <code>&lt;nav&gt;&lt;/nav&gt;</code> 修改如下：</p>
<pre><code><span class="xml"><span class="tag">&lt;<span class="title">nav</span>&gt;</span>
<span class="tag">&lt;<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">a</span> <span class="attribute">title</span>=<span class="value">"主页"</span> <span class="attribute">href</span>=<span class="value">"/"</span>&gt;</span>home<span class="tag">&lt;/<span class="title">a</span>&gt;</span><span class="tag">&lt;/<span class="title">span</span>&gt;</span>
</span>&lt;%<span class="ruby"> <span class="keyword">if</span> (user) { </span>%&gt;<span class="xml">
  <span class="tag">&lt;<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">a</span> <span class="attribute">title</span>=<span class="value">"发表"</span> <span class="attribute">href</span>=<span class="value">"/post"</span>&gt;</span>post<span class="tag">&lt;/<span class="title">a</span>&gt;</span><span class="tag">&lt;/<span class="title">span</span>&gt;</span>
  <span class="tag">&lt;<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">a</span> <span class="attribute">title</span>=<span class="value">"登出"</span> <span class="attribute">href</span>=<span class="value">"/logout"</span>&gt;</span>logout<span class="tag">&lt;/<span class="title">a</span>&gt;</span><span class="tag">&lt;/<span class="title">span</span>&gt;</span>
</span>&lt;%<span class="ruby"> } <span class="keyword">else</span> { </span>%&gt;<span class="xml">
  <span class="tag">&lt;<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">a</span> <span class="attribute">title</span>=<span class="value">"登录"</span> <span class="attribute">href</span>=<span class="value">"/login"</span>&gt;</span>login<span class="tag">&lt;/<span class="title">a</span>&gt;</span><span class="tag">&lt;/<span class="title">span</span>&gt;</span>
  <span class="tag">&lt;<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">a</span> <span class="attribute">title</span>=<span class="value">"注册"</span> <span class="attribute">href</span>=<span class="value">"/reg"</span>&gt;</span>register<span class="tag">&lt;/<span class="title">a</span>&gt;</span><span class="tag">&lt;/<span class="title">span</span>&gt;</span>
</span>&lt;%<span class="ruby"> } </span>%&gt;<span class="xml">
<span class="tag">&lt;/<span class="title">nav</span>&gt;</span></span>
</code></pre><p>在 <code>&lt;article&gt;</code> 后添加如下代码：</p>
<pre><code>&lt;<span class="preprocessor">%</span> <span class="keyword">if</span> <span class="comment">(success)</span> { <span class="preprocessor">%</span>&gt;
  &lt;div&gt;&lt;<span class="preprocessor">%</span>= success <span class="preprocessor">%</span>&gt;&lt;/div&gt;
&lt;<span class="preprocessor">%</span> } <span class="preprocessor">%</span>&gt;
&lt;<span class="preprocessor">%</span> <span class="keyword">if</span> <span class="comment">(error)</span> { <span class="preprocessor">%</span>&gt;
  &lt;div&gt;&lt;<span class="preprocessor">%</span>= error <span class="preprocessor">%</span>&gt; &lt;/div&gt;
&lt;<span class="preprocessor">%</span> } <span class="preprocessor">%</span>&gt;
</code></pre><p>修改 index.js ，将 <code>app.get(&#39;/&#39;)</code> 修改如下：</p>
<pre><code><span class="tag">app</span><span class="class">.get</span>(<span class="string">'/'</span>, function (req, res) {
  <span class="tag">res</span><span class="class">.render</span>(<span class="string">'index'</span>, {
    <span class="attribute">title</span>: <span class="string">'主页'</span>,
    <span class="attribute">user</span>: req.session.user,
    <span class="attribute">success</span>: req.<span class="function">flash</span>(<span class="string">'success'</span>).<span class="function">toString</span>(),
    <span class="attribute">error</span>: req.<span class="function">flash</span>(<span class="string">'error'</span>).<span class="function">toString</span>()
  });
});
</code></pre><p>将 <code>app.get(&#39;reg&#39;)</code> 修改如下：</p>
<pre><code><span class="tag">app</span><span class="class">.get</span>(<span class="string">'/reg'</span>, function (req, res) {
  <span class="tag">res</span><span class="class">.render</span>(<span class="string">'reg'</span>, {
    <span class="attribute">title</span>: <span class="string">'注册'</span>,
    <span class="attribute">user</span>: req.session.user,
    <span class="attribute">success</span>: req.<span class="function">flash</span>(<span class="string">'success'</span>).<span class="function">toString</span>(),
    <span class="attribute">error</span>: req.<span class="function">flash</span>(<span class="string">'error'</span>).<span class="function">toString</span>()
  });
});
</code></pre><p>现在运行我们的博客，注册成功后显示如下：</p>
<p><img src="https://github.com/nswbmw/N-blog/blob/master/public/images/1.13.jpg?raw=true" alt=""></p>
<p>我们通过对 session 的使用实现了对用户状态的检测，再根据不同的用户状态显示不同的导航信息。<br>简单解释一下流程：用户在注册成功后，把用户信息存入 session ，页面跳转到主页显示 <strong>注册成功！</strong> 的字样。同时把 session 中的用户信息赋给变量 user ，在渲染 index.ejs 文件时通过检测 user 判断用户是否在线，根据用户状态的不同显示不同的导航信息。</p>
<p><code>success: req.flash(&#39;success&#39;).toString()</code> 的意思是将成功的信息赋值给变量 <code>success</code>， <code>error: req.flash(&#39;error&#39;).toString()</code> 的意思是将错误的信息赋值给变量  <code>error</code> ，然后我们在渲染 ejs 模版文件时传递这两个变量来进行检测并显示通知。</p>
<h3 id="登录与登出响应">登录与登出响应</h3><p>现在我们来实现用户登录的功能。</p>
<p>打开 index.js ，将 <code>app.post(&#39;/login&#39;)</code> 修改如下：</p>
<pre><code>app.post(<span class="string">'/login'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(req, res)</span> </span>{
  <span class="comment">//生成密码的 md5 值</span>
  <span class="keyword">var</span> md5 = crypto.createHash(<span class="string">'md5'</span>),
      password = md5.update(req.body.password).digest(<span class="string">'hex'</span>);
  <span class="comment">//检查用户是否存在</span>
  User.<span class="keyword">get</span>(req.body.name, <span class="function"><span class="keyword">function</span> <span class="params">(err, user)</span> </span>{
    <span class="keyword">if</span> (!user) {
      req.flash(<span class="string">'error'</span>, <span class="string">'用户不存在!'</span>); 
      <span class="keyword">return</span> res.redirect(<span class="string">'/login'</span>);<span class="comment">//用户不存在则跳转到登录页</span>
    }
    <span class="comment">//检查密码是否一致</span>
    <span class="keyword">if</span> (user.password != password) {
      req.flash(<span class="string">'error'</span>, <span class="string">'密码错误!'</span>); 
      <span class="keyword">return</span> res.redirect(<span class="string">'/login'</span>);<span class="comment">//密码错误则跳转到登录页</span>
    }
    <span class="comment">//用户名密码都匹配后，将用户信息存入 session</span>
    req.session.user = user;
    req.flash(<span class="string">'success'</span>, <span class="string">'登陆成功!'</span>);
    res.redirect(<span class="string">'/'</span>);<span class="comment">//登陆成功后跳转到主页</span>
  });
});
</code></pre><p>将 <code>app.get(&#39;/login&#39;)</code> 修改如下：</p>
<pre><code><span class="tag">app</span><span class="class">.get</span>(<span class="string">'/login'</span>, function (req, res) {
    <span class="tag">res</span><span class="class">.render</span>(<span class="string">'login'</span>, {
        <span class="attribute">title</span>: <span class="string">'登录'</span>,
        <span class="attribute">user</span>: req.session.user,
        <span class="attribute">success</span>: req.<span class="function">flash</span>(<span class="string">'success'</span>).<span class="function">toString</span>(),
        <span class="attribute">error</span>: req.<span class="function">flash</span>(<span class="string">'error'</span>).<span class="function">toString</span>()});
});
</code></pre><p>(这样就不会出现 ‘user is not defined’ 的错误了)</p>
<p>接下来我们实现登出响应。修改 <code>app.get(&#39;/logout&#39;)</code> 如下：</p>
<pre><code>app.<span class="keyword">get</span>(<span class="string">'/logout'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(req, res)</span> </span>{
  req.session.user = <span class="literal">null</span>;
  req.flash(<span class="string">'success'</span>, <span class="string">'登出成功!'</span>);
  res.redirect(<span class="string">'/'</span>);<span class="comment">//登出成功后跳转到主页</span>
});
</code></pre><p><strong>注意：</strong>通过把 req.session.user 赋值 null 丢掉 session 中用户的信息，实现用户的退出。</p>
<p>登录后页面显示如下：</p>
<p><img src="https://github.com/nswbmw/N-blog/blob/master/public/images/1.14.jpg?raw=true" alt=""></p>
<p>登出后页面显示如下：</p>
<p><img src="https://github.com/nswbmw/N-blog/blob/master/public/images/1.15.jpg?raw=true" alt=""></p>
<p>至此，我们实现了用户注册与登陆的功能，并且根据用户登录状态显示不同的导航。</p>
<h3 id="页面权限控制">页面权限控制</h3><p>我们虽然已经完成了用户注册与登陆的功能，但并不能阻止比如已经登陆的用户访问 localhost:3000/reg 页面，读者可亲自尝试下。为此，我们需要为页面设置访问权限。即注册和登陆页面应该阻止已登陆的用户访问，登出及后面我们将要实现的发表页只对已登录的用户开放。如何实现页面权限的控制呢？我们可以把用户登录状态的检查放到路由中间件中，在每个路径前增加路由中间件，即可实现页面权限控制。我们添加 <code>checkNotLogin</code> 和 <code>checkLogin</code> 函数来实现这个功能。</p>
<pre><code><span class="function"><span class="keyword">function</span> <span class="title">checkLogin</span><span class="params">(req, res, next)</span></span> {
  <span class="keyword">if</span> (!req.session.user) {
    req.flash(<span class="string">'error'</span>, <span class="string">'未登录!'</span>); 
    res.redirect(<span class="string">'/login'</span>);
  }
  <span class="built_in">next</span>();
}

<span class="function"><span class="keyword">function</span> <span class="title">checkNotLogin</span><span class="params">(req, res, next)</span></span> {
  <span class="keyword">if</span> (req.session.user) {
    req.flash(<span class="string">'error'</span>, <span class="string">'已登录!'</span>); 
    res.redirect(<span class="string">'back'</span>);//返回之前的页面
  }
  <span class="built_in">next</span>();
}
</code></pre><p><code>checkNotLogin</code> 和 <code>checkLogin</code> 用来检测是否登陆，并通过 <code>next()</code> 转移控制权，检测到未登录则跳转到登录页，检测到已登录则跳转到前一个页面。</p>
<p>最终 index.js 代码如下：</p>
<pre><code><span class="keyword">var</span> crypto = require(<span class="string">'crypto'</span>),
    User = require(<span class="string">'../models/user.js'</span>);

module.exports = <span class="function"><span class="keyword">function</span><span class="params">(app)</span> </span>{
  app.<span class="keyword">get</span>(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(req, res)</span> </span>{
    res.render(<span class="string">'index'</span>, {
      title: <span class="string">'主页'</span>,
      user: req.session.user,
      success: req.flash(<span class="string">'success'</span>).toString(),
      error: req.flash(<span class="string">'error'</span>).toString()
    });
  });

  app.<span class="keyword">get</span>(<span class="string">'/reg'</span>, checkNotLogin);
  app.<span class="keyword">get</span>(<span class="string">'/reg'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(req, res)</span> </span>{
    res.render(<span class="string">'reg'</span>, {
      title: <span class="string">'注册'</span>,
      user: req.session.user,
      success: req.flash(<span class="string">'success'</span>).toString(),
      error: req.flash(<span class="string">'error'</span>).toString()
    });
  });

  app.post(<span class="string">'/reg'</span>, checkNotLogin);
  app.post(<span class="string">'/reg'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(req, res)</span> </span>{
    <span class="keyword">var</span> name = req.body.name,
        password = req.body.password,
        password_re = req.body[<span class="string">'password-repeat'</span>];
    <span class="keyword">if</span> (password_re != password) {
      req.flash(<span class="string">'error'</span>, <span class="string">'两次输入的密码不一致!'</span>); 
      <span class="keyword">return</span> res.redirect(<span class="string">'/reg'</span>);
    }
    <span class="keyword">var</span> md5 = crypto.createHash(<span class="string">'md5'</span>),
        password = md5.update(req.body.password).digest(<span class="string">'hex'</span>);
    <span class="keyword">var</span> newUser = <span class="keyword">new</span> User({
        name: name,
        password: password,
        email: req.body.email
    });
    User.<span class="keyword">get</span>(newUser.name, <span class="function"><span class="keyword">function</span> <span class="params">(err, user)</span> </span>{
      <span class="keyword">if</span> (err) {
        req.flash(<span class="string">'error'</span>, err);
        <span class="keyword">return</span> res.redirect(<span class="string">'/'</span>);
      }
      <span class="keyword">if</span> (user) {
        req.flash(<span class="string">'error'</span>, <span class="string">'用户已存在!'</span>);
        <span class="keyword">return</span> res.redirect(<span class="string">'/reg'</span>);
      }
      newUser.save(<span class="function"><span class="keyword">function</span> <span class="params">(err, user)</span> </span>{
        <span class="keyword">if</span> (err) {
          req.flash(<span class="string">'error'</span>, err);
          <span class="keyword">return</span> res.redirect(<span class="string">'/reg'</span>);
        }
        req.session.user = user;
        req.flash(<span class="string">'success'</span>, <span class="string">'注册成功!'</span>);
        res.redirect(<span class="string">'/'</span>);
      });
    });
  });

  app.<span class="keyword">get</span>(<span class="string">'/login'</span>, checkNotLogin);
  app.<span class="keyword">get</span>(<span class="string">'/login'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(req, res)</span> </span>{
    res.render(<span class="string">'login'</span>, {
      title: <span class="string">'登录'</span>,
      user: req.session.user,
      success: req.flash(<span class="string">'success'</span>).toString(),
      error: req.flash(<span class="string">'error'</span>).toString()
    }); 
  });

  app.post(<span class="string">'/login'</span>, checkNotLogin);
  app.post(<span class="string">'/login'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(req, res)</span> </span>{
    <span class="keyword">var</span> md5 = crypto.createHash(<span class="string">'md5'</span>),
        password = md5.update(req.body.password).digest(<span class="string">'hex'</span>);
    User.<span class="keyword">get</span>(req.body.name, <span class="function"><span class="keyword">function</span> <span class="params">(err, user)</span> </span>{
      <span class="keyword">if</span> (!user) {
        req.flash(<span class="string">'error'</span>, <span class="string">'用户不存在!'</span>); 
        <span class="keyword">return</span> res.redirect(<span class="string">'/login'</span>);
      }
      <span class="keyword">if</span> (user.password != password) {
        req.flash(<span class="string">'error'</span>, <span class="string">'密码错误!'</span>); 
        <span class="keyword">return</span> res.redirect(<span class="string">'/login'</span>);
      }
      req.session.user = user;
      req.flash(<span class="string">'success'</span>, <span class="string">'登陆成功!'</span>);
      res.redirect(<span class="string">'/'</span>);
    });
  });

  app.<span class="keyword">get</span>(<span class="string">'/post'</span>, checkLogin);
  app.<span class="keyword">get</span>(<span class="string">'/post'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(req, res)</span> </span>{
    res.render(<span class="string">'post'</span>, {
      title: <span class="string">'发表'</span>,
      user: req.session.user,
      success: req.flash(<span class="string">'success'</span>).toString(),
      error: req.flash(<span class="string">'error'</span>).toString()
    });
  });

  app.post(<span class="string">'/post'</span>, checkLogin);
  app.post(<span class="string">'/post'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(req, res)</span> </span>{
  });

  app.<span class="keyword">get</span>(<span class="string">'/logout'</span>, checkLogin);
  app.<span class="keyword">get</span>(<span class="string">'/logout'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(req, res)</span> </span>{
    req.session.user = <span class="literal">null</span>;
    req.flash(<span class="string">'success'</span>, <span class="string">'登出成功!'</span>);
    res.redirect(<span class="string">'/'</span>);
  });

  <span class="function"><span class="keyword">function</span> <span class="title">checkLogin</span><span class="params">(req, res, next)</span> </span>{
    <span class="keyword">if</span> (!req.session.user) {
      req.flash(<span class="string">'error'</span>, <span class="string">'未登录!'</span>); 
      res.redirect(<span class="string">'/login'</span>);
    }
    next();
  }

  <span class="function"><span class="keyword">function</span> <span class="title">checkNotLogin</span><span class="params">(req, res, next)</span> </span>{
    <span class="keyword">if</span> (req.session.user) {
      req.flash(<span class="string">'error'</span>, <span class="string">'已登录!'</span>); 
      res.redirect(<span class="string">'back'</span>);
    }
    next();
  }
};
</code></pre><p><strong>注意：</strong>为了维护用户状态和 flash 的通知功能，我们给每个 ejs 模版文件传入了以下三个值：</p>
<pre><code>user: req<span class="class">.session</span><span class="class">.user</span>,
success: req.<span class="function"><span class="title">flash</span><span class="params">(<span class="string">'success'</span>)</span></span>.<span class="function"><span class="title">toString</span><span class="params">()</span></span>,
error: req.<span class="function"><span class="title">flash</span><span class="params">(<span class="string">'error'</span>)</span></span>.<span class="function"><span class="title">toString</span><span class="params">()</span></span>
</code></pre><h2 id="发表文章">发表文章</h2><p>现在我们的博客已经具备了用户注册、登陆、页面权限控制的功能，接下来我们完成博客最核心的部分——发表文章。在这一节，我们将会实现发表文章的功能，完成整个博客的设计。</p>
<h3 id="页面设计-1">页面设计</h3><p>我们先来完成发表页的页面设计。在 views 文件夹下新建 post.ejs ，添加如下代码：</p>
<pre><code><span class="xml"></span>&lt;%-<span class="ruby"> <span class="keyword">include</span> header </span>%&gt;<span class="xml">
<span class="tag">&lt;<span class="title">form</span> <span class="attribute">method</span>=<span class="value">"post"</span>&gt;</span>
  标题：<span class="tag">&lt;<span class="title">br</span> /&gt;</span>
  <span class="tag">&lt;<span class="title">input</span> <span class="attribute">type</span>=<span class="value">"text"</span> <span class="attribute">name</span>=<span class="value">"title"</span> /&gt;</span><span class="tag">&lt;<span class="title">br</span> /&gt;</span>
  正文：<span class="tag">&lt;<span class="title">br</span> /&gt;</span>
  <span class="tag">&lt;<span class="title">textarea</span> <span class="attribute">name</span>=<span class="value">"post"</span> <span class="attribute">rows</span>=<span class="value">"20"</span> <span class="attribute">cols</span>=<span class="value">"100"</span>&gt;</span><span class="tag">&lt;/<span class="title">textarea</span>&gt;</span><span class="tag">&lt;<span class="title">br</span> /&gt;</span>
  <span class="tag">&lt;<span class="title">input</span> <span class="attribute">type</span>=<span class="value">"submit"</span> <span class="attribute">value</span>=<span class="value">"发表"</span> /&gt;</span>
<span class="tag">&lt;/<span class="title">form</span>&gt;</span>
</span>&lt;%-<span class="ruby"> <span class="keyword">include</span> footer </span>%&gt;<span class="xml"></span>
</code></pre><h3 id="文章模型">文章模型</h3><p>仿照用户模型，我们将文章模型命名为 Post 对象，它拥有与 User 相似的接口，分别是 <code>Post.get</code> 和 <code>Post.prototype.save</code> 。<code>Post.get</code> 的功能是从数据库中获取文章，可以按指定用户获取，也可以获取全部的内容。<code>Post.prototype.save</code> 是 Post 对象原型的方法，用来将文章保存到数据库。<br>在 models 文件夹下新建 post.js ，添加如下代码：</p>
<pre><code><span class="keyword">var</span> mongodb = require(<span class="string">'./db'</span>);

<span class="function"><span class="keyword">function</span> <span class="title">Post</span><span class="params">(name, title, post)</span> </span>{
  <span class="keyword">this</span>.name = name;
  <span class="keyword">this</span>.title = title;
  <span class="keyword">this</span>.post = post;
}

module.exports = Post;

<span class="comment">//存储一篇文章及其相关信息</span>
Post.prototype.save = <span class="function"><span class="keyword">function</span><span class="params">(callback)</span> </span>{
  <span class="keyword">var</span> date = <span class="keyword">new</span> Date();
  <span class="comment">//存储各种时间格式，方便以后扩展</span>
  <span class="keyword">var</span> time = {
      date: date,
      year : date.getFullYear(),
      month : date.getFullYear() + <span class="string">"-"</span> + (date.getMonth() + <span class="number">1</span>),
      day : date.getFullYear() + <span class="string">"-"</span> + (date.getMonth() + <span class="number">1</span>) + <span class="string">"-"</span> + date.getDate(),
      minute : date.getFullYear() + <span class="string">"-"</span> + (date.getMonth() + <span class="number">1</span>) + <span class="string">"-"</span> + date.getDate() + <span class="string">" "</span> + 
      date.getHours() + <span class="string">":"</span> + (date.getMinutes() &lt; <span class="number">10</span> ? <span class="string">'0'</span> + date.getMinutes() : date.getMinutes()) 
  }
  <span class="comment">//要存入数据库的文档</span>
  <span class="keyword">var</span> post = {
      name: <span class="keyword">this</span>.name,
      time: time,
      title: <span class="keyword">this</span>.title,
      post: <span class="keyword">this</span>.post
  };
  <span class="comment">//打开数据库</span>
  mongodb.open(<span class="function"><span class="keyword">function</span> <span class="params">(err, db)</span> </span>{
    <span class="keyword">if</span> (err) {
      <span class="keyword">return</span> <span class="keyword">callback</span>(err);
    }
    <span class="comment">//读取 posts 集合</span>
    db.collection(<span class="string">'posts'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(err, collection)</span> </span>{
      <span class="keyword">if</span> (err) {
        mongodb.close();
        <span class="keyword">return</span> <span class="keyword">callback</span>(err);
      }
      <span class="comment">//将文档插入 posts 集合</span>
      collection.insert(post, {
        safe: <span class="literal">true</span>
      }, <span class="function"><span class="keyword">function</span> <span class="params">(err)</span> </span>{
        mongodb.close();
        <span class="keyword">if</span> (err) {
          <span class="keyword">return</span> <span class="keyword">callback</span>(err);<span class="comment">//失败！返回 err</span>
        }
        <span class="keyword">callback</span>(<span class="literal">null</span>);<span class="comment">//返回 err 为 null</span>
      });
    });
  });
};

<span class="comment">//读取文章及其相关信息</span>
Post.get = <span class="function"><span class="keyword">function</span><span class="params">(name, callback)</span> </span>{
  <span class="comment">//打开数据库</span>
  mongodb.open(<span class="function"><span class="keyword">function</span> <span class="params">(err, db)</span> </span>{
    <span class="keyword">if</span> (err) {
      <span class="keyword">return</span> <span class="keyword">callback</span>(err);
    }
    <span class="comment">//读取 posts 集合</span>
    db.collection(<span class="string">'posts'</span>, <span class="function"><span class="keyword">function</span><span class="params">(err, collection)</span> </span>{
      <span class="keyword">if</span> (err) {
        mongodb.close();
        <span class="keyword">return</span> <span class="keyword">callback</span>(err);
      }
      <span class="keyword">var</span> query = {};
      <span class="keyword">if</span> (name) {
        query.name = name;
      }
      <span class="comment">//根据 query 对象查询文章</span>
      collection.find(query).sort({
        time: -<span class="number">1</span>
      }).toArray(<span class="function"><span class="keyword">function</span> <span class="params">(err, docs)</span> </span>{
        mongodb.close();
        <span class="keyword">if</span> (err) {
          <span class="keyword">return</span> <span class="keyword">callback</span>(err);<span class="comment">//失败！返回 err</span>
        }
        <span class="keyword">callback</span>(<span class="literal">null</span>, docs);<span class="comment">//成功！以数组形式返回查询的结果</span>
      });
    });
  });
};
</code></pre><h3 id="发表响应">发表响应</h3><p>接下来我们给发表文章注册响应，打开 index.js ，在 <code>User = require(&#39;../models/user.js&#39;)</code> 后添加一行代码：</p>
<pre><code>,Post = <span class="built_in">require</span>(<span class="string">'../models/post.js'</span>);
</code></pre><p>修改 <code>app.post(&#39;/post&#39;)</code> 如下：</p>
<pre><code><span class="keyword">app</span>.<span class="keyword">post</span>('/<span class="keyword">post</span>', checkLogin);
<span class="keyword">app</span>.<span class="keyword">post</span>('/<span class="keyword">post</span>', function (req, res) {
  <span class="keyword">var</span> currentUser = req.session.user,
      <span class="keyword">post</span> = new <span class="keyword">Post</span>(currentUser.name, req.body.title, req.body.<span class="keyword">post</span>);
  <span class="keyword">post</span>.<span class="keyword">save</span>(function (<span class="keyword">err</span>) {
    <span class="keyword">if</span> (<span class="keyword">err</span>) {
      req.flash('<span class="keyword">error</span>', <span class="keyword">err</span>); 
      <span class="keyword">return</span> res.redirect('/');
    }
    req.flash('success', '发布成功!');
    res.redirect('/');<span class="comment">//发表成功跳转到主页</span>
  });
});
</code></pre><p>最后，我们修改 index.ejs ，让主页右侧显示发表过的文章及其相关信息。</p>
<p>打开 index.ejs ，修改如下：</p>
<pre><code><span class="xml"></span><span class="vbscript">&lt;%- include header %&gt;</span><span class="xml">
</span><span class="vbscript">&lt;% posts.forEach(<span class="keyword">function</span> (post, index) { %&gt;</span><span class="xml">
  <span class="tag">&lt;<span class="title">p</span>&gt;</span><span class="tag">&lt;<span class="title">h2</span>&gt;</span><span class="tag">&lt;<span class="title">a</span> <span class="attribute">href</span>=<span class="value">"#"</span>&gt;</span></span><span class="vbscript">&lt;%= post.title %&gt;</span><span class="xml"><span class="tag">&lt;/<span class="title">a</span>&gt;</span><span class="tag">&lt;/<span class="title">h2</span>&gt;</span><span class="tag">&lt;/<span class="title">p</span>&gt;</span>
  <span class="tag">&lt;<span class="title">p</span> <span class="attribute">class</span>=<span class="value">"info"</span>&gt;</span>
    作者：<span class="tag">&lt;<span class="title">a</span> <span class="attribute">href</span>=<span class="value">"#"</span>&gt;</span></span><span class="vbscript">&lt;%= post.name %&gt;</span><span class="xml"><span class="tag">&lt;/<span class="title">a</span>&gt;</span> | 
    日期：</span><span class="vbscript">&lt;%= post.<span class="built_in">time</span>.<span class="built_in">minute</span> %&gt;</span><span class="xml">
  <span class="tag">&lt;/<span class="title">p</span>&gt;</span>
  <span class="tag">&lt;<span class="title">p</span>&gt;</span></span><span class="vbscript">&lt;%- post.post %&gt;</span><span class="xml"><span class="tag">&lt;/<span class="title">p</span>&gt;</span>
</span><span class="vbscript">&lt;% }) %&gt;</span><span class="xml">
</span><span class="vbscript">&lt;%- include footer %&gt;</span><span class="xml"></span>
</code></pre><p>打开 index.js ，修改 <code>app.get(&#39;/&#39;)</code> 如下：</p>
<pre><code>app.<span class="keyword">get</span>(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(req, res)</span> </span>{
  Post.<span class="keyword">get</span>(<span class="literal">null</span>, <span class="function"><span class="keyword">function</span> <span class="params">(err, posts)</span> </span>{
    <span class="keyword">if</span> (err) {
      posts = [];
    } 
    res.render(<span class="string">'index'</span>, {
      title: <span class="string">'主页'</span>,
      user: req.session.user,
      posts: posts,
      success: req.flash(<span class="string">'success'</span>).toString(),
      error: req.flash(<span class="string">'error'</span>).toString()
    });
  });
});
</code></pre><p>至此，我们的博客就建成了。</p>
<p>启动我们的博客，发表一篇博文，如图所示:</p>
<p><img src="https://github.com/nswbmw/N-blog/blob/master/public/images/1.16.jpg?raw=true" alt=""></p>
<p>此时，查看一下数据库，如图所示：</p>
<p><img src="https://github.com/nswbmw/N-blog/blob/master/public/images/1.17.jpg?raw=true" alt=""></p>
<p><strong>Tips</strong>：Robomongo 是一个基于 Shell 的跨平台开源 MongoDB 管理工具。嵌入了 JavaScript 引擎和 MongoDB mongo 。只要你会使用 mongo shell ，你就会使用 Robomongo，它提供语法高亮、自动完成、差别视图等。</p>
<p>下载安装 Robomongo后，运行我们的博客，注册一个用户并发表几篇文章，初次打开 Robomongo ，点击 <strong>Create</strong> 创建一个名为 blog （名字自定）的数据库链接（默认监听 localhost:27017），点击 <strong>Connect</strong> 就连接到数据库了。如图所示：</p>
<p><img src="https://github.com/nswbmw/N-blog/blob/master/public/images/1.18.jpg?raw=true" alt=""></p>
</span>
      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/express/" rel="tag">#express</a>
          
            <a href="/tags/node-js/" rel="tag">#node.js</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-prev post-nav-item">
            
          </div>

          <div class="post-nav-next post-nav-item">
            
              <a href="/2015/09/15/jQuery设计理念/" rel="next">jQuery设计理念</a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>

 </div>

        

        
          <div class="comments" id="comments">
            
          </div>
        
      </div>

      
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" src="/images/default_avatar.jpg" alt="Hang Weiping" itemprop="image"/>
          <p class="site-author-name" itemprop="name">Hang Weiping</p>
        </div>
        <p class="site-description motion-element" itemprop="description">人只有无限努力</p>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">3</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            
              <span class="site-state-item-count">0</span>
              <span class="site-state-item-name">分类</span>
              
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
              <span class="site-state-item-count">5</span>
              <span class="site-state-item-name">标签</span>
              </a>
          </div>

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/" target="_blank">github</a>
              </span>
            
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
        </div>

      </section>

      
        <section class="post-toc-wrap sidebar-panel-active">
          <div class="post-toc-indicator-top post-toc-indicator"></div>
          <div class="post-toc">
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#学习环境"><span class="nav-number">1.</span> <span class="nav-text">学习环境</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#快速开始"><span class="nav-number">2.</span> <span class="nav-text">快速开始</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#安装_Express"><span class="nav-number">2.1.</span> <span class="nav-text">安装 Express</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#新建一个工程"><span class="nav-number">2.2.</span> <span class="nav-text">新建一个工程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#工程结构"><span class="nav-number">2.3.</span> <span class="nav-text">工程结构</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#路由控制"><span class="nav-number">3.</span> <span class="nav-text">路由控制</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#工作原理"><span class="nav-number">3.1.</span> <span class="nav-text">工作原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#路由规则"><span class="nav-number">3.2.</span> <span class="nav-text">路由规则</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#添加路由规则"><span class="nav-number">3.3.</span> <span class="nav-text">添加路由规则</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#模版引擎"><span class="nav-number">4.</span> <span class="nav-text">模版引擎</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#什么是模板引擎"><span class="nav-number">4.1.</span> <span class="nav-text">什么是模板引擎</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用模板引擎"><span class="nav-number">4.2.</span> <span class="nav-text">使用模板引擎</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#页面布局"><span class="nav-number">4.3.</span> <span class="nav-text">页面布局</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#搭建多人博客"><span class="nav-number">5.</span> <span class="nav-text">搭建多人博客</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#功能分析"><span class="nav-number">5.1.</span> <span class="nav-text">功能分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#设计目标"><span class="nav-number">5.2.</span> <span class="nav-text">设计目标</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#路由规划"><span class="nav-number">5.3.</span> <span class="nav-text">路由规划</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用数据库"><span class="nav-number">6.</span> <span class="nav-text">使用数据库</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#MongoDB简介"><span class="nav-number">6.1.</span> <span class="nav-text">MongoDB简介</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装MongoDB"><span class="nav-number">6.2.</span> <span class="nav-text">安装MongoDB</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#连接MongoDB"><span class="nav-number">6.3.</span> <span class="nav-text">连接MongoDB</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#会话支持"><span class="nav-number">6.4.</span> <span class="nav-text">会话支持</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#注册和登陆"><span class="nav-number">7.</span> <span class="nav-text">注册和登陆</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#页面设计"><span class="nav-number">7.1.</span> <span class="nav-text">页面设计</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#页面通知"><span class="nav-number">7.2.</span> <span class="nav-text">页面通知</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#注册响应"><span class="nav-number">7.3.</span> <span class="nav-text">注册响应</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#登录与登出响应"><span class="nav-number">7.4.</span> <span class="nav-text">登录与登出响应</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#页面权限控制"><span class="nav-number">7.5.</span> <span class="nav-text">页面权限控制</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#发表文章"><span class="nav-number">8.</span> <span class="nav-text">发表文章</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#页面设计-1"><span class="nav-number">8.1.</span> <span class="nav-text">页面设计</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#文章模型"><span class="nav-number">8.2.</span> <span class="nav-text">文章模型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#发表响应"><span class="nav-number">8.3.</span> <span class="nav-text">发表响应</span></a></li></ol></li></ol></div>
            
          </div>
          <div class="post-toc-indicator-bottom post-toc-indicator"></div>
        </section>
      

    </div>
  </aside>


    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner"> <div class="copyright" >
  
  &copy; &nbsp;  2013 - 
  <span itemprop="copyrightYear">2015</span>
  <span class="with-love">
    <i class="icon-next-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Hang Weiping</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="">Hexo</a> 驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="">
    Next
  </a>
</div>


 </div>
    </footer>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  
  
    
    

  


  
  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/fancy-box.js?v=0.4.5.1"></script>


  <script type="text/javascript" src="/js/helpers.js?v=0.4.5.1"></script>
  

  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" src="/js/motion_global.js?v=0.4.5.1" id="motion.global"></script>




  <script type="text/javascript" src="/js/nav-toggle.js?v=0.4.5.1"></script>
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  
<script type="text/javascript" src="/js/bootstrap.scrollspy.js?v=0.4.5.1" id="bootstrap.scrollspy.custom"></script>


<script type="text/javascript" id="sidebar.toc.highlight">
  $(document).ready(function () {
    var tocSelector = '.post-toc';
    var $tocSelector = $(tocSelector);
    var activeCurrentSelector = '.active-current';

    $tocSelector
      .on('activate.bs.scrollspy', function () {
        var $currentActiveElement = $(tocSelector + ' .active').last();

        removeCurrentActiveClass();
        $currentActiveElement.addClass('active-current');

        $tocSelector[0].scrollTop = $currentActiveElement.position().top;
      })
      .on('clear.bs.scrollspy', function () {
        removeCurrentActiveClass();
      });

    function removeCurrentActiveClass () {
      $(tocSelector + ' ' + activeCurrentSelector)
        .removeClass(activeCurrentSelector.substring(1));
    }

    function processTOC () {
      getTOCMaxHeight();
      toggleTOCOverflowIndicators();
    }

    function getTOCMaxHeight () {
      var height = $('.sidebar').height() -
                   $tocSelector.position().top -
                   $('.post-toc-indicator-bottom').height();

      $tocSelector.css('height', height);

      return height;
    }

    function toggleTOCOverflowIndicators () {
      tocOverflowIndicator(
        '.post-toc-indicator-top',
        $tocSelector.scrollTop() > 0 ? 'show' : 'hide'
      );

      tocOverflowIndicator(
        '.post-toc-indicator-bottom',
        $tocSelector.scrollTop() >= $tocSelector.find('ol').height() - $tocSelector.height() ? 'hide' : 'show'
      )
    }

    $(document).on('sidebar.motion.complete', function () {
      processTOC();
    });

    $('body').scrollspy({ target: tocSelector });
    $(window).on('resize', function () {
      if ( $('.sidebar').hasClass('sidebar-active') ) {
        processTOC();
      }
    });

    onScroll($tocSelector);

    function onScroll (element) {
      element.on('mousewheel DOMMouseScroll', function (event) {
          var oe = event.originalEvent;
          var delta = oe.wheelDelta || -oe.detail;

          this.scrollTop += ( delta < 0 ? 1 : -1 ) * 30;
          event.preventDefault();

          toggleTOCOverflowIndicators();
      });
    }

    function tocOverflowIndicator (indicator, action) {
      var $indicator = $(indicator);
      var opacity = action === 'show' ? 0.4 : 0;
      $indicator.velocity ?
        $indicator.velocity('stop').velocity({
          opacity: opacity
        }, { duration: 100 }) :
        $indicator.stop().animate({
          opacity: opacity
        }, 100);
    }

  });
</script>

<script type="text/javascript" id="sidebar.nav">
  $(document).ready(function () {
    var html = $('html');
    var TAB_ANIMATE_DURATION = 200;
    var hasVelocity = $.isFunction(html.velocity);

    $('.sidebar-nav li').on('click', function () {
      var item = $(this);
      var activeTabClassName = 'sidebar-nav-active';
      var activePanelClassName = 'sidebar-panel-active';
      if (item.hasClass(activeTabClassName)) {
        return;
      }

      var currentTarget = $('.' + activePanelClassName);
      var target = $('.' + item.data('target'));

      hasVelocity ?
        currentTarget.velocity('transition.slideUpOut', TAB_ANIMATE_DURATION, function () {
          target
            .velocity('stop')
            .velocity('transition.slideDownIn', TAB_ANIMATE_DURATION)
            .addClass(activePanelClassName);
        }) :
        currentTarget.animate({ opacity: 0 }, TAB_ANIMATE_DURATION, function () {
          currentTarget.hide();
          target
            .stop()
            .css({'opacity': 0, 'display': 'block'})
            .animate({ opacity: 1 }, TAB_ANIMATE_DURATION, function () {
              currentTarget.removeClass(activePanelClassName);
              target.addClass(activePanelClassName);
            });
        });

      item.siblings().removeClass(activeTabClassName);
      item.addClass(activeTabClassName);
    });

    $('.post-toc a').on('click', function (e) {
      e.preventDefault();
      var targetSelector = escapeSelector(this.getAttribute('href'));
      var offset = $(targetSelector).offset().top;
      hasVelocity ?
        html.velocity('stop').velocity('scroll', {
          offset: offset  + 'px',
          mobileHA: false
        }) :
        $('html, body').stop().animate({
          scrollTop: offset
        }, 500);
    });

    // Expand sidebar on post detail page by default, when post has a toc.
    var $tocContent = $('.post-toc-content');
    if (isDesktop() && CONFIG.sidebar === 'post') {
      if ($tocContent.length > 0 && $tocContent.html().trim().length > 0) {
        displaySidebar();
      }
    }
  });
</script>



  <script type="text/javascript">
    $(document).ready(function () {
      if (CONFIG.sidebar === 'always') {
        displaySidebar();
      }
      if (isMobile()) {
        FastClick.attach(document.body);
      }
    });
  </script>

  

  
  

  
  <script type="text/javascript" src="/js/lazyload.js"></script>
  <script type="text/javascript">
    $(function () {
      $("#posts").find('img').lazyload({
        placeholder: "/images/loading.gif",
        effect: "fadeIn"
      });
    });
  </script>
</body>
</html>
